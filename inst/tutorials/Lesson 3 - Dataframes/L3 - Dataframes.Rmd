---
title: "Lesson 3: Dataframes" 
author: "Boaz"
date: "2024-08-21"
output:
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered  
editor_options: 
  markdown: 
    wrap: 72
---

```{=html}
<style>
h1, h2, h3, h4, h5, h6 {
  direction: rtl;
}
p {
  direction: rtl;
}
</style>
```
```{r setup, include=FALSE}
library(learnr)
library(gradethis)

tutorial_options(
  exercise.timelimit = 60,
  # A simple checker function that just returns the message in the check chunk
  exercise.checker = function(check_code, ...) {
    list(
      message = eval(parse(text = check_code)),
      correct = logical(0),
      type = "info",
      location = "append"
    )
  }
)

knitr::opts_chunk$set(error = TRUE)
gradethis::gradethis_setup()
```

```{r prepare-df1}
df1 = data.frame(subject = 1:6,
                city = c("Jerusalem","Haifa","Tel-Aviv","Eilat","Jerusalem","Tel-Aviv"),
                self_efficacy_score = c(2.3, 2.5, 2.1, 3, 2.2, 2.6))
```

## טבלאות - היכרות

בשיעור הנוכחי נלמד לעבוד עם סוג נוסף של אובייקטים, שנפוצים מאוד בעבודה
שלנו בR: טבלאות, או באנגלית - Dataframes

אובייקטים אלו מורכבים משורות ועמודות, כמו באקסל, עם ערכים בתוך כל אחת
מהמשבצות של הטבלה. לכל עמודה יש כותרת, המתארת את המידע באותה עמודה.
שורות שונות בדרך כלל יבטאו תצפיות שונות, למשל - נתונים של נבדקים שונים
או סבבים שונים של מטלה מסוימת עבור אותו נבדק. לפניכם דוגמה של טבלה
המתארת את הנתונים הדמוגרפיים והציונים במדד תחושת מסוגלות עצמית עבור שישה
נבדקים פיקטיביים.

```{r}
df1 = data.frame(subject = 1:6,
                city = c("Jerusalem","Haifa","Tel-Aviv","Eilat","Jerusalem","Tel-Aviv"),
                self_efficacy_score = c(2.3, 2.5, 2.1, 3, 2.2, 2.6))

print(df1)
```

ניתן לראות כי נבדק 1 גר בירושלים והוא בעל ציון 2.3 במדד תחושת המסוגלות
העצמית. לעומת זאת נבדק 2 גר בחיפה והוא בעל ציון של 2.5 במדד המסוגלות
העצמית.

כפי שניתן לראות בשורות הקוד המייצרות את הטבלה הנ"ל, טבלאות (Dataframes)
הן אסופה של מספר וקטורים בעלי אותו האורך - כשלכל וקטור מוצמדת כותרת.
במקרה הנ"ל הטבלה מורכבת מ3 וקטורים, כל אחד באורך 6 ערכים. בהתאם לכך
שמדובר בוקטורים - כל עמודה חייבת להכיל סוג אחד של נתונים בלבד- numeric,
character, boolean וכו', אך עמודות שונות באותה טבלה יכולות להכיל סוגים
שונים של מידע.

## יצירת מסגרת נתונים וחיתוכים

### יצירת טבלאות

הדרך הכי פשוטה לייצר טבלה היא באמצעות הפקודה data.frame(), שמאפשרת לנו
לצרף יחד מספר וקטורים לכדי טבלה. זו לרוב לא תהיה הדרך בה נייצר את
הטבלאות שאיתן נעבוד, אבל חושב להכיר גם אותה.

ניתן לייצר את מסגרת הנתונים באמצעות וקטורים שאנחנו מגדירים בתוך
הפונקציה, כפי שעשינו בדוגמה לעיל, אך אפשר גם להשתמש בוקטורים שהגדרנו
מראש. שימו לב: העמודות החדשות חייבות להיות באותו האורך של העמדות שכבר
קיימות בטבלה. במידה ונגדיר עמודה חדשה באמצעות וקטור קצר או ארוך יותר,
נקבל הודעת שגיאה

> המקרה החריג, בו לא נקבל הודעת שגיאה הוא כשנתשמש בוקטור בעל אורך שהוא
> בדיוק חצי, שליש, רבע וכו' מאורך הטבלה. במקרים כאלו התכנה תשכפל את
> הוקטור לפי מספר הפעמים הנדרש כדי להגיע לאורך התואם את מספר השורות
> בטבלה].

שורות הקוד הבאות מייצרות טבלה זהה לטבלה הקודמת. ערכו את הפונקציה המייצרת
את הטבלה כך שתתווסף עמודה רביעית בשם "gender" ומלאו אותה בערכים
לבחירתכם.

-   doesnt work

```{r exercise1, exercise=TRUE, exercise.eval = FALSE, exercise.cap = "יצירת טבלה", }

subjects = 1:6
city_per_subject = c("Jerusalem","Haifa","Tel-Aviv","Eilat","Jerusalem","Tel-Aviv")
self_efficacy_per_subject =  c(2.3, 2.5, 2.1, 3, 2.2, 2.6)

df1 = data.frame(subject = subjects,
                 city =  city_per_subject,
                 self_efficacy_score = self_efficacy_per_subject)

print(df1)
```

```{r exercise1-check}
grade_result(
  pass_if(~identical(names(.result), c("subject","city","self_efficacy_score","gender")))
)
```

### חיתוך באמצעות סוגריים מרובעים [ , ]

#### חיתוך משבצות בודדות

כשם שאנחנו יכולים לשלוף ערכים מתוך וקטור או לערוך ערך מסויים מתוכו, כך
ניתן לעשות גם בטבלאות - אבל כיוון שלטבלאות יש 2 מימדים (שורות ועמודות)
נצטרך להשתמש ב2 אינדקסים כדי להתייחס למשבצת ספציפית. במקרים כאלו האינדקס
תמיד יתחיל בשורות (ערך ראשון משמאל) ואז יעבור לעמודות, כשבין שני
האינדקסים מפריד פסיק. למשל: החיתוך df1[2,3] מתייחס לשורה 2, עמודה 3 של
הטבלה שנקראת df1.

בשורות הקוד הבאות אנחנו שולפים את הערך של העיר (עמודה 2) בה גר הנבדק
שבשורה השלישית ומדפיסים אותו ואז משנים את הערך של ציון תחושת המסוגלות
העצמית (עמודה 3) של הנבדק בשורה הרביעית ל3.1 ומדפיסים את הטבלה הערוכה.

```{r df3, exercise=TRUE, exercise.eval = FALSE, exercise.setup = "prepare-df1"}

x = df1[3,2]
print(x)

df1[4,3] = 2
print(df1)
```

נסו בעצמכם: בחרו משבצת מסוימת שאתם רוצים לשלוף ותערכו את האינדקסים כך
שיפנו למשבצת הנכונה. נסו לערוך את הערכים במשבצות שונות.

```{r logicals, echo = FALSE}
question(" מה קורה כשאתם משנים ערך אחד של עמודה מספרית לערך מסוג character?",
         answer("מקבלים הודעת שגיאה"),
         answer("הערך הופך להיות מסוג numeric"),
         answer("העמודה מכילה גם ערכים מסוג numeric וגם ערך אחד מסוג character"),
         answer("העמודה כולה הופכת להיות מסוג character", correct = TRUE),
         allow_retry = TRUE
)
```

#### חיתוך וקטורים ותת-טבלאות

ניתן להשתמש בסוגריים מרובעים גם כדי לחתוך תת-טבלה מתוך הטבלה המקורית.
בחיתוך כזה במקום לתת מספר בודד כאינדקס עבור השורות / העמודות נשתמש
בוקטור המציין את מספרי השורות / עמודות שאנחנו רוצים לחתוך.

בנוסף, אנחנו יכולים גם לחתוך מתוך הטבלה שורה או עמודה שלמה באמצעות השארת
האינדקס המתאים ריק.

כשמדובר בעמודות, ניתן גם לציין את העמודות שברצוננו לחתוך באמצעות שמות
העמודות. במקום לשים באינדקס העמודות מספר, נספק את שם העמודה או וקטור של
שמות העמודות אותן נרצה לחתוך.

לפניכם מספר דוגמאות:

```{r df4, exercise=TRUE, exercise.eval = FALSE, , exercise.setup = "prepare-df1"}

# (1)
df2 = df1[c(2,4,6),1:2] # שורות 2,4 ו 6 מעמודות 1 ו 2
print(df2)

# (2)
row1 = df1[1,] # שורה 1, כל העמודות
print(row1)

columns_2_and_3 = df1[,c(2,3)] # כל השורות, עמודה 2 ו3
print(columns_2_and_3)


city_subj_3_and_1 = df1[c(3,1),"city"] # עיר המגורים של הנבדקים בשורות 3 ו1
print(city_subj_3_and_1)

subj_and_self_efficacy = df1[,c("subject","self_efficacy_score")] # כל השורות - אבל רק את העמודות של מספר המשתמש וציון תחושת המסוגלות העצמית
print(subj_and_self_efficacy)

```

### פקד ה\$

דרך נוספת לשלוף עמודה שלמה מתוך הנתונים נעזרת בפקד ה$ת לדוגמה: df1$city
ישלוף את עמודת הערים ויציג אותה כוקטור

אם נבצע השמה לחיתוך שכזה נוכל לערוך עמודה קיימת או לייצר עמודה חדש -
במידה ונשתמש בשם של עמודה קיימת הוקטור שנכניס ידרוס את העמודה ויחליף
אותה. במידה ונשתמש בשם של עמודה שלא נמצאת בטבלה תיווצר עמודה חדשה בשם
זה. בדרך זו ניתן גם לייצר עמודות חדשות על סמך עמודות קיימות, או לבצע
תיקונים בעמודות הקיימות.

להלן מספר דוגמאות:

```{r df5, exercise=TRUE, exercise.eval = FALSE, , exercise.setup = "prepare-df1"}

# חיתוך עמודת הערים מתוך הטבלה
print(df1$city)

# יצירת עמודה חדשה המכילה נתוני גיל עבור הנבדקים
df1$age = c(21,35,42,32,24,19)

# דריסת עמודת הערים
df1$city = c("Haifa","Be'er-Sheva","Jerusalem","Be'er-Sheva","Jerusalem","Acre")


# יצירת עמודות על סמך עמודות קיימות
df1$age_in_months = df1$age * 12
df1$age_over_25 = df1$age > 25
df1$age_relative_to_mean = df1$age  -  mean(df1$age )


print(df1)

```

## טעינת טבלאות

עד עכשיו הגדרנו את הטבלאות שלנו בעצמנו. בפועל - רוב הטבלאות איתן נעבוד
בR יכילו נתונים שנאספו על ידי תוכנות אחרות. כדי לנתח אותן בR נצטרך קודם
כל לייבא את הנתונים לסביבת העבודה שלנו.

ישנן מספר פונקציות בR אשר מאפשרות לנו לטעון קובצים מפורמט CSV או XSLX
(שני הפורמטים העיקריים לשמירת נתונים המיוצגים בטבלה), אך הדרך הידודותית
ביותר למשתמש נעזרת בכלי של Rstudio שנועד להקל על ייבוא הקבצים.

כדי לגשת לכלי הייבוא, פתחו את R Rstudio ובחרו בלשונית "file" שבסרגל
הכלים שבראש החלון של התוכנה. מכאן בחרו ב "Import Dataset" ובאחת מ2
האפשרויות הראשונות במידה ואתם מעוניינים לטעון קובץ CSV, או שלישית במידה
והקובץ שלכם הוא מפורמט xslx.

> בשיעור זה נתרגל טעינת קובץ מפורמט csv ולכן נבחר באפשרות השנייה) -
> "From Text (readr)..." (גם הראשונה אפשרית, אבל השנייה נוחה יותר \<
> כשנבחר באפשרות זו ייפתח לנו חלון שיאפשר לנו לבחור קובץ לייבוא, לשלוט
> בכמה אפשרויות בתהליך הייבוא ולצפות בתצוגה מקדימה של הטבלה שאנחנו
> מייבאים. תהליך הייבוא קורה בכמה שלבים: \< 1. בחירת הקובץ: נלחץ על
> כפתור ה"Browse..." שבפינה הימנית עליונה של החלון. ייפתח עבורנו חלון בו
> נוכל לחפש ולבחור את הקובץ שאנו מעוניינים לייבא. \< 2. שינוי אפשרויות
> הייבוא בהתאם לקובץ שלנו: החלון מאפשר לנו להתאים את אופן הייבוא לאופן
> בו הנתונים שמורים בקובץ שלנו. למשל, הוא מאפשר לנו לדווח האם השורה
> הראשונה בקובץ שאנחנו מייבאים מכילה את הכותרות של העמודות או לא ולדלג
> על מספר שורות במידה והקובץ מכיל כמה שורות שאינן מכילות נתונים בתחילת
> הקובץ (באמצעות שדה ה"Skip"). בנוסף, החלון מאפשר לנו גם לקבוע מה יהיה
> שם האובייקט בו נרצה לשמור את הטבלה שאנחנו מייבאים, באמצעות השדה
> "Name". \< 3. ייבוא הקובץ. משערכנו את האפשרויות כך שהן תואמות לאופן בו
> נרצה לייבא את הנתונים מהקובץ נוכל לייבא אותו בפועל ב2 דרכים. הדרך
> הראשונה היא באמצעות לחיצה על כפתור "Import" שבתחתית החלון. כפתור זה
> יישם את הייבוא וייבא את הטבלה לסביבת העבודה שלנו. \< בפועל, מה שקורה
> כאן הוא שהחלון מייצר שורות קוד שמנהלות את הייבוא לפי ההעדפות שלנו
> והכפתור מבצע את אותן שורות קוד. ניתן לראות את שורות הקוד בחלונית
> בתחתית החלון. \< לרוב, לא נרצה רק לייבא את הטבלה לסביבת העבודה הנוכחית
> שלנו, אלא נרצה גם להעתיק את שורות הקוד האלו לקובץ הסקריפט, כך שבהרצה
> עתידית של הקובץ הקוד ייבצע את ייבוא הטבלה באופן אוטומטי. כדי לעשות זאת
> נוכל להעתיק את שורות הקוד מחלונית הקוד ולהדביק אותן בקובץ הסקריפט
> שלנו.

תרגיל:\* ייבאו את הקובץ\* "nned_for_cognition.csv" שבאתר המודל של הקורס.

ראשית, הוריד את הקובץ ושמרו אותו בתיקייה לבחירתכם, ואח"כ היעזרו בחלון
הייבוא כדי לייצר את שורות הקוד שיאפשרו ייבוא תקין של הטבלה לסביבת העבודה
שלכם. הריצו את שורות הקוד וודאו שהייבוא התנהל באופן תקין.

העתיקו את שורות הקוד אלו לחלונית הקוד הבאה והריצו אותה. לצורף התרגיל,
שמרו את הטבלה בסביבת העבודה בשם "table1"

```{r e-import, exercise=TRUE, exercise.eval = FALSE, exercise.cap = "ייבוא נתונים" }
# הדביקו כאן את הקוד המייבא את הטבלה
# שימו לב לכלול את השורה שמייבאת את החבילה
# readr
# אך *אין* צורך להעתיק את הקריאה לפוקציה 
# View(table1)


# קוד שמדפיס את השורות הראשונות בטבלה כדי לוודא שהייבוא נעשה באופן תקין
print(head(table1))
```

```{r e-import-check}
#****
grade_result(
  pass_if(~identical(.result, c( "session_id","age","gender", "attention_check", "nfc_01" ,"nfc_02r" ,"nfc_03r", "nfc_04" , "nfc_05","nfc_06r" )))
)
```

באופן דומה, אך מעט פשוט יותר - ניתן גם לייצא טבלאות לקבצי CSV. הייצוא
נעשה באמצעות הפקודה הבא:

```{r export, exercise=TRUE, exercise.eval = FALSE, , exercise.setup = "prepare-df1"}

write.csv(df1, "export dataframe example.csv")

```

בדוגמה זו ייצאנו את הטבלה df1 שנמצאת בסביבת העבודה שלנו מהתרגילים
הקודמים ושמרנו אותה בתור קובץ CSV בשם "export dataframe example.csv".

הקובץ יישמר בתיקיית העבודה (working directory) המוגדרת אצלכם בR כרגע -
תיקיית ברירת המחדל שאליה תיגש התוכנה כדי לייבוא ולשמור קבצים. ניתן לברר
מה היא תיקיית העבודה הנוכחית שלכם ולשנות אותה באמצעות הפונקציות הבאות:

```{r getwd, exercise=TRUE, exercise.eval = FALSE, , exercise.setup = "prepare-df1"}

# מציאת כתובת העבודה
working_directory = getwd()
print(working_directory)

# שינוי כתובת העבודה
# כרגע אנחנו מגדירים את התיקייה לפי התיקייה הנוכחית, ולכן היא לא תשתנה. החליפו את האובייקט 
# "working_directory" 
# בכתובת לתיקייה אחרת כדי לשנות את תיקיית העבודה, במידה ואתם מעוניינים בכך

new_working_directory = working_directory
setwd(new_working_directory)


```

לחלופין, במקום לשנות את תיקיית העבודה ניתן גם לספק לפונקציית הייצוא את
הכתובת השלמה בה תרצו לשמור את הקובץ. לדוגמה:

```{r, eval = FALSE}
write.csv(df1, "C:/Users/one/Desktop/R files/DRL experiment/V3/data files/export dataframe example.csv")
```

### פונקציות שימושיות

ישנן מספר פונקציות בסיסיות בR שהינן שימושיות מאוד לעיסוק בטבלאות. הן
מאפשרות לנו להבין את המבנה והתוכן של טבלה מבלי להדפיס או לעבור על כולה.
במידה ואנחנו מתעסקים בטבלה שייבאנו, אנחנו לרוב נצטרך להזכיר לעצמנו מה
האורך של הטבלה, מה הן העמודות שבה, איך קוראים להם וכו'.

#### מימדי הטבלה

בקטע הקוד הבא ישנן מספר פונקציות המאפשרות לנו לגלות את מספר השורות
והעמודות בטבלה שלנו. פונקציות אלו שימושיות במיוחד כשאנחנו צריכים להתייחס
למימדים אלו בקוד, כך שבמקום לבדוק בעצמנו את אורך הטבלה ולהקליד את המספר
המתאים נוכל להשתמש בקוד שיעשה את הבדיקה הזו עבורנו.

העתיקו לתחילת הקטע את השורות המייבאות את הקובץ "need_for_cognition.csv"
ובחנו את הפלט של הפונקציות השונות

```{r dimensions, exercise=TRUE, exercise.eval = FALSE, , exercise.setup = "prepare-df1"}

# הדביקו כאן את שורות הקוד המייבאות את הקובץ. שימו לב לשמור אותו בתור table1



# מספר השורות והעמודות שבטבלה שייבאנו
dim(table1)

# מספר השורות
nrow(table1)

# מספר העמודות
ncol(table1)


# שימוש במספר השורות כדי לייצר עמודה חדשה  
table1$subject_index = 1:nrow(table1)

```

#### צפייה בתמצית הטבלה, שמות העמודות ובשורות הראשונות / אחרונות

בנוסף, ישנן מספר פונקציות שיאפשרו לנו לבצע הצצה ראשונית אל תוך התוכן של
הטבלה. פונקציות אלו שימושיות במיוחד כשאנחנו טוענים נתונים שאנחנו לא
בטוחים איך הם מסודרים ו/או מה כל עמודה מכילה.

מתוכן, יש לנו פונקציות המאפשרות לבצע חיתוך מהיר של השורות הראשונות או
האחרונות בטבלה (head ו tail), פונקציות שמסכמות לנו את הנתונים בכל עמודה
ופונקציה ששולפת את שמות העמודות של הטבלה.

```{r summary_and_names, exercise=TRUE, exercise.eval = FALSE, , exercise.setup = "prepare-df1"}


# הדביקו כאן את שורות הקוד המייבאות את הקובץ. שימו לב לשמור אותו בתור table1





# שליפת השורות הראשונות. ברירת המחדל היא 6 שורות, אך ניתן גם לבקש מספר אחר של שורות
head(table1)
head(table1,4)

# סוף הטבלה
tail(table1)

# סיכום של כל העמודות בטבלה, בהתאם לסוג העמודה
summary(table1)


# שליפת שמות העמודות 
col_names = names(table1)
print(colnames)

```

פונקציות שימושיות לוקטורים:

mean() sd()

range() summary()

median() quantile()

cor()

## תרגיל מסכם

טקסט והסבר

אפשר לתת שאלות שמציגות פתרון

1.  שאלה ראשונה

```{r ex1, exercise = TRUE}

```

```{r ex1-solution}
    a -> 1
```

2.  שאלות שמציגות רמזים

```{r ex2, exercise = TRUE}

```

```{r ex2-solution}
    b -> 5
    # the solution is here
```

::: {#ex2-hint}
**רמז:** כשיש רמז הוא מחליף פתרון גם אם הוגדר.
:::

## הגשת התרגיל

סיימת? מעולה! עכשיו הגיע הזמן להגיש את התרגיל.\
יש ללחוץ על הכפתור: Generate\
להעתיק את הטקסט שמופיע בחלון למטה ולהגישו במודל\
בהצלחה!

```{r context="server"}
learnrhash::encoder_logic()
```

```{r encode, echo=FALSE}
learnrhash::encoder_ui()
```
