---
title: "Lesson 3: Dataframes" 
author: "Boaz"
date: "2024-08-21"
output:
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered  
editor_options: 
  markdown: 
    wrap: 72
---

```{=html}
<style>
h1, h2, h3, h4, h5, h6 {
  direction: rtl;
}
p {
  direction: rtl;
}

.text-block1 {
  direction: rtl;       /* Set text direction to right-to-left */
  text-align: right;
  background-color: #f0f0f0; /* Light grey background */
  padding: 10px;
  border-radius: 5px;
  border: 1px solid #ddd; /* Light border */
  margin: 10px 0; /* Space around the block */
  
</style>
```
```{r setup, include=FALSE}
library(learnr)
library(gradethis)

tutorial_options(
  exercise.timelimit = 60,
  # A simple checker function that just returns the message in the check chunk
  exercise.checker = function(check_code, ...) {
    list(
      message = eval(parse(text = check_code)),
      correct = logical(0),
      type = "info",
      location = "append"
    )
  }
)

knitr::opts_chunk$set(error = TRUE)
gradethis::gradethis_setup()
```

```{r prepare-df1}
df1 = data.frame(subject = 1:6,
                city = c("Jerusalem","Haifa","Tel-Aviv","Eilat","Jerusalem","Tel-Aviv"),
                self_efficacy_score = c(2.3, 2.5, 2.1, 3, 2.2, 2.6))
```

## טבלאות - היכרות

בשיעור הנוכחי נלמד לעבוד עם סוג נוסף של אובייקטים שנפוצים מאוד בעבודה
שלנו בR: טבלאות, או באנגלית - Dataframes

הטבלאות מורכבות משורות ועמודות, כמו באקסל, עם ערכים בתוך כל אחת מהמשבצות
של הטבלה. לכל עמודה יש כותרת, המתארת את המידע באותה עמודה. שורות שונות
בדרך כלל יבטאו תצפיות שונות, למשל - נתונים של נבדקים שונים או סבבים
שונים של מטלה מסוימת עבור אותו נבדק. לפניכם דוגמה של טבלה המתארת את
הנתונים הדמוגרפיים והציונים במדד תחושת מסוגלות עצמית עבור שישה נבדקים
פיקטיביים.

```{r}
df1 = data.frame(subject = 1:6,
                city = c("Jerusalem","Haifa","Tel-Aviv","Eilat","Jerusalem","Tel-Aviv"),
                self_efficacy_score = c(2.3, 2.5, 2.1, 3, 2.2, 2.6))

print(df1)
```

ניתן לראות כי נבדק 1 גר בירושלים והוא בעל ציון 2.3 במדד תחושת המסוגלות
העצמית. לעומת זאת נבדק 2 גר בחיפה והוא בעל ציון של 2.5 במדד המסוגלות
העצמית.

כפי שניתן לראות בשורות הקוד המייצרות את הטבלה הנ"ל, טבלאות (Dataframes)
הן אסופה של מספר וקטורים בעלי אותו האורך - כשלכל וקטור מוצמדת כותרת.
במקרה הנ"ל הטבלה מורכבת מ3 וקטורים, כל אחד באורך 6 ערכים. בהתאם לכך
שמדובר בוקטורים - כל עמודה חייבת להכיל סוג אחד של נתונים בלבד- numeric,
character, boolean וכו', אך עמודות שונות באותה טבלה יכולות להכיל סוגים
שונים של מידע.

## יצירת מסגרת נתונים וחיתוכים

### יצירת טבלאות

הדרך הכי פשוטה לייצר טבלה היא באמצעות הפקודה data.frame(), שמאפשרת לנו
לצרף יחד מספר וקטורים לכדי טבלה. זו לרוב לא תהיה הדרך בה נייצר את
הטבלאות שאיתן נעבוד, אבל חושב להכיר גם אותה.

ניתן לייצר את מסגרת הנתונים באמצעות וקטורים שאנחנו מגדירים בתוך
הפונקציה, כפי שעשינו בדוגמה הקודמת, אך אפשר גם להשתמש בוקטורים שהוגדרו
מראש. שימו לב: העמודות החדשות חייבות להיות באותו האורך של העמדות שכבר
קיימות בטבלה. במידה ונגדיר עמודה חדשה באמצעות וקטור קצר או ארוך יותר,
נקבל הודעת שגיאה

::: text-block1
המקרה החריג, בו לא נקבל הודעת שגיאה הוא כשנתשמש בוקטור בעל אורך שהוא
בדיוק חצי, שליש, רבע וכו' מאורך הטבלה. במקרים כאלו התכנה תשכפל את הוקטור
לפי מספר הפעמים הנדרש כדי להגיע לאורך התואם את מספר השורות בטבלה.
:::

שורות הקוד הבאות מייצרות טבלה זהה לטבלה הקודמת. ערכו את הפונקציה המייצרת
את הטבלה כך שתתווסף עמודה רביעית בשם "gender" ומלאו אותה בערכים
לבחירתכם.


```{r exercise1, exercise=TRUE, exercise.eval = FALSE, exercise.cap = "יצירת טבלה", }

subjects = 1:6
city_per_subject = c("Jerusalem","Haifa","Tel-Aviv","Eilat","Jerusalem","Tel-Aviv")
self_efficacy_per_subject =  c(2.3, 2.5, 2.1, 3, 2.2, 2.6)

df1 = data.frame(subject = subjects,
                 city =  city_per_subject,
                 self_efficacy_score = self_efficacy_per_subject)

print(df1)
```

```{r exercise1-check}
grade_result(
  pass_if(~identical(names(.result), c("subject","city","self_efficacy_score","gender")))
)
```

### חיתוך באמצעות סוגריים מרובעים [ , ]

#### חיתוך משבצות בודדות

חיתוך ושליפה של ערכים מתוך טבלה נעשית באופן דומה מאוד לשליפת ערכים מתוך
וקטור - אבל כיוון שלטבלאות יש 2 מימדים (שורות ועמודות) נצטרך להשתמש ב2
אינדקסים כדי להתייחס למשבצת / משבצות שמעניינות אותנו. האינדקס הראשון
יתייחס לשורות (ערך ראשון משמאל) והשני לעמודות, כשבין שני האינדקסים מפריד
פסיק. למשל: החיתוך df1[2,3] מתייחס לשורה 2, עמודה 3 של הטבלה שנקראת df1.

בשורות הקוד הבאות אנחנו שולפים את הערך של העיר (עמודה 2) בה גר הנבדק
שבשורה השלישית ומדפיסים אותו.

בהמשך, הקוד מבצע השמה מחדש לערך של שורה 4, עמודה 3: ציון תחושת המסוגלות
העצמית של הנבדק בשורה הרביעית. הקוד משנה את ערך זה כך שיהיה שווה ל2
ומדפיס את הטבלה המעודכנת.

```{r df3, exercise=TRUE, exercise.eval = FALSE, exercise.setup = "prepare-df1"}

x = df1[3,2]
print(x)

df1[4,3] = 2
print(df1)
```

נסו בעצמכם: בחרו משבצת מסוימת שאתם רוצים לשלוף ותערכו את האינדקסים כך
שיפנו למשבצת הנכונה. נסו לערוך את הערכים במשבצות שונות.

```{r Q1, echo = FALSE}
question(" מה קורה כשאתם משנים ערך אחד של עמודה מספרית (למשל - ציון המסוגלות העצמית) לערך מסוג character?",
         answer("מקבלים הודעת שגיאה"),
         answer("הערך הופך להיות מסוג numeric"),
         answer("העמודה מכילה גם ערכים מסוג numeric וגם ערך אחד מסוג character"),
         answer("העמודה כולה הופכת להיות מסוג character", correct = TRUE),
         allow_retry = TRUE
)
```

```{r logicals, echo = FALSE}
question(HTML("<div style='direction: rtl;'>מה קורה כשאתם משנים ערך אחד של עמודה מספרית (למשל - ציון המסוגלות העצמית) לערך מסוג character?</div>"),
         answer("מקבלים הודעת שגיאה"),
         answer("הערך הופך להיות מסוג numeric"),
         answer("העמודה מכילה גם ערכים מסוג numeric וגם ערך אחד מסוג character"),
         answer("העמודה כולה הופכת להיות מסוג character", correct = TRUE),
         allow_retry = TRUE
)
```

#### חיתוך וקטורים ותת-טבלאות

ניתן להשתמש בסוגריים מרובעים גם כדי לחתוך תת-טבלה מתוך הטבלה המקורית.
בחיתוך כזה במקום לתת מספר בודד כאינדקס עבור השורות / העמודות נשתמש
בוקטור המציין את מספרי השורות / עמודות שאנחנו רוצים לחתוך.

בנוסף, אנחנו יכולים גם לחתוך מתוך הטבלה שורה או עמודה שלמה באמצעות השארת
האינדקס המתאים ריק.

כשמדובר בעמודות, ניתן גם לציין את העמודות שברצוננו לחתוך באמצעות שמות
העמודות. במקום לשים באינדקס העמודות מספר, נספק את שם העמודה או וקטור של
שמות העמודות אותן נרצה לחתוך.

לפניכם מספר דוגמאות:

```{r df4, exercise=TRUE, exercise.eval = FALSE, , exercise.setup = "prepare-df1"}

# (1)
df2 = df1[c(2,4,6),1:2] # שורות 2,4 ו 6 מעמודות 1 ו 2
print(df2)

# (2)
row1 = df1[1,] # שורה 1, כל העמודות
print(row1)

columns_2_and_3 = df1[,c(2,3)] # כל השורות, עמודה 2 ו3
print(columns_2_and_3)


city_subj_3_and_1 = df1[c(3,1),"city"] # עיר המגורים של הנבדקים בשורות 3 ו1
print(city_subj_3_and_1)

subj_and_self_efficacy = df1[,c("subject","self_efficacy_score")] # כל השורות - אבל רק את העמודות של מספר המשתמש וציון תחושת המסוגלות העצמית
print(subj_and_self_efficacy)

```

### פקד ה\$

דרך נוספת לשלוף עמודה שלמה מתוך הנתונים נעזרת בפקד ה\$. לדוגמה:
df1\$city ישלוף את עמודת הערים

אם נבצע השמה לחיתוך שכזה נוכל לערוך עמודה קיימת או לייצר עמודה חדשה:

במידה ונשתמש בשם של עמודה קיימת הוקטור שנכניס ידרוס את העמודה ויחליף
אותה. במידה ונשתמש בשם של עמודה שלא נמצאת בטבלה תיווצר עמודה חדשה בשם
זה.

בדרך זו ניתן גם לייצר עמודות חדשות על סמך עמודות קיימות, או לבצע תיקונים
בעמודות הקיימות.

להלן מספר דוגמאות:

```{r df5, exercise=TRUE, exercise.eval = FALSE, , exercise.setup = "prepare-df1"}

# חיתוך עמודת הערים מתוך הטבלה
print(df1$city)

# יצירת עמודה חדשה המכילה נתוני גיל עבור הנבדקים
df1$age = c(21,35,42,32,24,19)
print(df1)

# דריסת עמודת הערים
df1$city = c("Haifa","Be'er-Sheva","Jerusalem","Be'er-Sheva","Jerusalem","Acre")
print(df1)

# יצירת עמודות על סמך עמודות קיימות
df1$se_above_2.5 = df1$self_efficacy_score > 2.5
df1$se_sclae_1_to_100 = df1$self_efficacy_score * 20
df1$se_relative_to_mean = df1$self_efficacy_score  -  mean(df1$self_efficacy_score)

print(df1)

```

## טעינת טבלאות

עד עכשיו הגדרנו את הטבלאות שלנו בעצמנו. בפועל - רוב הטבלאות איתן נעבוד
בR יכילו נתונים שנאספו על ידי תוכנות אחרות. כדי לנתח אותן בR נצטרך קודם
כל לייבא את הנתונים לסביבת העבודה שלנו.

ישנן מספר פונקציות בR אשר מאפשרות לנו לטעון קובצים מפורמט csv או xlsx
(שני הפורמטים העיקריים לשמירת נתונים המיוצגים בטבלה), אך הדרך הידודותית
ביותר למשתמש נעזרת בכלי של Rstudio שנועד להקל על ייבוא הקבצים.

כדי לגשת לכלי הייבוא, פתחו את Rstudio ובחרו בלשונית "file" שבסרגל הכלים
שבראש החלון של התוכנה. מכאן בחרו ב "Import Dataset" ובאחת מ2 האפשרויות
הראשונות במידה ואתם מעוניינים לטעון קובץ csv, או בשלישית במידה והקובץ
שלכם הוא מפורמט xslx.

בשיעור זה נתרגל טעינת קובץ מפורמט csv ולכן נבחר באפשרות השנייה - "From
Text (readr)...". גם האופצייה הראשונה אפשרית, אבל השנייה נוחה יותר.
כשנבחר באפשרות זו ייפתח לנו חלון שיאפשר לנו לבחור קובץ לייבוא, לשלוט
בכמה אפשרויות בתהליך הייבוא ולצפות בתצוגה מקדימה של הטבלה שאנחנו
מייבאים.

תהליך הייבוא קורה בכמה שלבים:

::: text-block1
**1) בחירת הקובץ:**

נלחץ על כפתור ה"Browse..." שבפינה הימנית עליונה של החלון. ייפתח עבורנו
חלון בו נוכל לחפש ולבחור את הקובץ שאנו מעוניינים לייבא.

**2) התאמת אפשרויות הייבוא:**

החלון מאפשר לנו להתאים את הייבוא לאופן בו הנתונים שמורים בקובץ שלנו.
למשל, הוא מאפשר לנו לבחור האם השורה הראשונה בקובץ שאנחנו מייבאים מכילה
את הכותרות של העמודות ולדלג על מספר שורות במידה והקובץ מכיל כמה שורות
שאינן מכילות נתונים בתחילת הקובץ (באמצעות שדה ה"Skip"). בנוסף, החלון
מאפשר לנו גם לקבוע מה יהיה שם האובייקט בו נרצה לשמור את הטבלה שאנחנו
מייבאים, באמצעות השדה "Name" ולערוך את סוג הנתונים בכל עמודה.

**3) ייבוא הקובץ:**

את הייבוא עצמו אפשר לבצע ב2 דרכים שונות:

הדרך הראשונה היא באמצעות לחיצה על כפתור "Import" שבתחתית החלון. כפתור זה
יבצע את שורות קוד המתאימות להעדפות שהגדרנו בחלון. ניתן לראות את שורות
קוד אלו בחלונית בתחתית החלון.

לרוב, לא נרצה רק לייבא את הטבלה לסביבת העבודה הנוכחית שלנו, אלא נרצה גם
להעתיק את שורות הקוד שמייבאות את הקובץ לקובץ הסקריפט שלנו, כך שבהרצה
עתידית של הקובץ הקוד ייבצע את ייבוא הטבלה באופן אוטומטי. כדי לעשות זאת
נעתיק את שורות הקוד מחלונית הקוד ונדביק אותן בקובץ הסקריפט שלנו - ואז
נריץ אותן מתוך הקובץ.

שורת הקוד הראשונה מייבאת את החבילה שנדרשת לצורך הייבוא, השנייה מבצעת את
הייבוא בפועל והשלישית פותחת עבורנו את הטבלה שייבאנו לצפייה. כשאנו
מעתיקים את הקוד לסקריפט בדרך כלל נעדיף להשמיט את השורה השלישית.
:::

**תרגיל:** ייבאו את הקובץ "need_for_cognition.csv" שבאתר המודל של הקורס
לסביבת העבודה שלכם בRstudio

ראשית, הוריד את הקובץ ושמרו אותו בתיקייה לבחירתכם, ואח"כ היעזרו בחלון
הייבוא כדי לייצר את שורות הקוד שיאפשרו ייבוא תקין של הטבלה לסביבת העבודה
שלכם. הריצו את שורות הקוד וודאו שהייבוא התנהל באופן תקין.

קובץ נתונים זה מתאר את ציוניהם של 2466 משתתפים בשאלון המודד "need for
cognition" - מידת הצורך . שאנשים מרגישים להבין את העולם סביבם. בפרק הבא
נציץ אל תוך טבלה זו ונבין את המבנה שלה.

```{r Q2, echo = FALSE}
question("מה הגיל של הנבדקת הראשונה בקובץ שייבאתם?",
         type = "learnr_text",
         answer("19", correct = TRUE),
         allow_retry = TRUE
)
```

### ייצוא טבלאות

לפני שנעבור לפרק הבא נציין את האופן בו נוכל לייצא קבצים מתוך R. פעולה זו
מתבקשת לאחר שייבאנו טבלה, ערכהו אותה - ואנחנו רוצים לשתף אץ הטבלה הערוכה
עם אנשים אחרים. כדי לשתף אותה נשמור אותה חזרה לקובץ csv אותו נוכל לשלוח
למי שנרצה.

:הייצוא נעשה באמצעות הפקודה הבא:

```{r export, eval = FALSE}

write.csv(df1, "export dataframe example.csv")

```

בדוגמה זו ייצאנו את הטבלה df1 שנמצאת בסביבת העבודה שלנו ושמרנו אותה בתור
קובץ CSV בשם "export dataframe example.csv".

הקובץ יישמר בתיקיית העבודה (working directory- תיקיית ברירת המחדל שאליה
תיגש התוכנה כדי לייבוא ולשמור קבצים) המוגדרת אצלכם בR . ניתן לברר מה היא
תיקיית העבודה הנוכחית שלכם ולשנות אותה באמצעות הפונקציות הבאות:

```{r getwd, exercise=TRUE, exercise.eval = FALSE, , exercise.setup = "prepare-df1"}

# מציאת כתובת העבודה
working_directory = getwd()
print(working_directory)

# שינוי כתובת העבודה
# כרגע אנחנו מגדירים את התיקייה לפי התיקייה הנוכחית, ולכן היא לא תשתנה. החליפו את האובייקט 
# "working_directory" 
# בכתובת לתיקייה אחרת כדי לשנות את תיקיית העבודה, במידה ואתם מעוניינים בכך

new_working_directory = working_directory
setwd(new_working_directory)

```

### בחינה ראשונית של טבלה מיובאת

ייבאנו טבלת נתונים - מה עכשיו?

בדרך כלל אחרי שנייבא טבלת נתונים נצטרך קודם כל להזכיר לעצמנו את המבנה
שלה - איך קוראים לעמודות? מה הם מכיליות? כמה תצפיות הטבלה מכילה ? וכו'

יש כמה פונקציות בR שיכולות לעזור לנו בכך.

#### מימדי הטבלה

בקטע הקוד הבא ישנן מספר פונקציות המאפשרות לנו לגלות את מספר השורות
והעמודות בטבלה שלנו. פונקציות אלו שימושיות במיוחד כשאנחנו צריכים להתייחס
למימדים אלו בקוד, כך שבמקום לבדוק בעצמנו את אורך הטבלה ולהקליד את המספר
המתאים נוכל להשתמש בקוד שיעשה את הבדיקה הזו עבורנו.

```{r dimensions, exercise=TRUE, exercise.eval = FALSE, , exercise.setup = "prepare-df1"}

# ייבאנו מראש את הקובץ עם נתוני השאלון שטענתם בתרגיל הקודם
# כעת נייצר עותק שלו ונבין את המבנה שלו
table1 = nfc


# מספר השורות והעמודות שבטבלה שייבאנו
dim(table1)

# מספר השורות
nrow(table1)

# מספר העמודות
ncol(table1)


# שימוש במספר השורות כדי לייצר עמודה חדשה  
table1$subject_index = 1:nrow(table1)

```

#### צפייה בתמצית הטבלה, שמות העמודות ובשורות הראשונות / אחרונות

בנוסף, ישנן מספר פונקציות שיאפשרו לנו לבצע הצצה ראשונית אל תוך התוכן של
הטבלה. פונקציות אלו שימושיות במיוחד כשאנחנו טוענים טבלאות גדולות,שיהיה
קשה לנו לעבור עליהן בשלמותן.

שורות הקוד הבאות מדגימות פונקציות המאפשרות לבצע חיתוך מהיר של השורות
הראשונות או האחרונות בטבלה (head ו tail), פונקצייה שמסכמת את הנתונים בכל
עמודה ופונקציה ששולפת את שמות העמודות של הטבלה.

```{r summary_and_names, exercise=TRUE, exercise.eval = FALSE, , exercise.setup = "prepare-df1"}


# הדביקו כאן את שורות הקוד המייבאות את הקובץ. שימו לב לשמור אותו בתור table1





# שליפת השורות הראשונות. ברירת המחדל היא 6 שורות, אך ניתן גם לבקש מספר אחר של שורות
head(table1)
head(table1,4)

# סוף הטבלה
tail(table1)

# סיכום של כל העמודות בטבלה, בהתאם לסוג העמודה
summary(table1)


# שליפת שמות העמודות 
col_names = names(table1)
print(colnames)

```

פונקציות שימושיות לוקטורים:

mean() sd()

range() summary()

median() quantile()

cor() table()

## תרגיל

ייבאנו עבורכם את הנתונים מהקובץ need_for_cognition.csv ושמרנו אותם בטבלה
הנקראת "table1".

השלימו את קטעי הקוד הבאים בהתאם להוראות שבהערות: \*

```{r exercise, exercise=TRUE, exercise.eval = FALSE, , exercise.setup = "prepare-df1"}

table1 = nfc

# הדפיסו את שמות העמודות בטבלה
column_names = ___________
print(column_names)

# כעת, יצרו טבלה נוספת המכילה את 100 השורות הראשונות של כל העמודות למעט העמודה הראשונה והעמודה הנקראה "attention_check"
table2 = _________

# וודאו שלטבלה החדה יש את מספר השורות ומספר העמודות הנדרשות (100 שורות ו9 עמודות)
number_of_columns =  ________
number_of_rows = _________

print(paste("table2 has",number_of_columns,"columns and",number_of_rows,"rows"))

# בטבלה ישנן 2 עמודות המציגות ציונים עבור שאלות שהינן בכיוון ההפוך ביחס לשאר השאלון 
# לפני שנוכל לחשב את המדד המשוכלל עבור השאלון נצטרך להפוך אותן חזרה
# ייצרו 3 עמודות חדשות עבור שאלות 02, 03 ו 06 שיכילו את הציון ההפוך לציון בעמודות המקוריות
# מאחר וציוני השאלון נעים בין 1 ל5, על מנת להפוך את הציון עלינו להחסיר את הציון המקורי מ6
# new column = 6 - old column
# מומלץ להיעזר בפקד ה$ כדי להגדיר את העמודות החדשות ולשלוף את ערכיהן של העמודות הישנות
# קראו לעמודות החדשות לפי שמות העמודות הישנות, אך ללא תוספת האות r
  



# כעת, ייצרו עמודה חדשה שתכיל את סכום ששת העמודות עבור כל נבדק

# שלפו את עמודה זו ושמרו אותה באובייקט הבא:
nfc_score_column = 
  
```


```{r exercise1-check}
grade_result(
  pass_if(~identical(names(.result), c("subject","city","self_efficacy_score","gender")))
)
```


