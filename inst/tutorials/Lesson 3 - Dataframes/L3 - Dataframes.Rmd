---
title: "Lesson 3: Dataframes" 
output:

  learnr::tutorial:
    progressive: true
    allow_skip: false

     
runtime: shiny_prerendered  

---

<!-- the above should be in the beginning of each lesson -->

<!-- code to format so all text appears rtl (Hebrew) -->

```{=html}
<style>

/* Adjust tab navigation */
.nav-tabs {
    direction: rtl; /* Set the direction to RTL */
    float: right; /* Align tabs container to the right */
    margin-bottom: 15px; /* Add space below tabs */
}

.nav-tabs > li {
    float: none; /* Disable float for individual tab items */
    display: inline-block; /* Display tab items inline */
    direction: rtl; /* Ensure tabs respect RTL direction */
}

.nav-tabs > li > a {
    margin-left: 2px; /* Space between tabs */
}

.nav-tabs > li.active > a {
    border-bottom-color: #ddd; /* Adjust the active tab's bottom border */
}
</style>


```
<!-- tutorial options and cheching options - TODO set params -->

```{r setup, include=FALSE}
library(learnr)

tutorial_options(
  exercise.timelimit = 60,
  # A simple checker function that just returns the message in the check chunk
  exercise.checker = function(check_code, ...) {
    list(
      message = eval(parse(text = check_code)),
      correct = logical(0),
      type = "info",
      location = "append"
    )
  }
)


knitr::opts_chunk$set(error = TRUE)
#gradethis::gradethis_setup()
```


```{r prepare-df1}
nycflights <- nycflights13::flights
```



## טבלאות - היכרות

בשיעור הנוכחי נלמד לעבוד עם סוג נוסף של אובייקטים, שנפוצים מאוד בעבודה שלנו בR: טבלאות, או באנגלית - Dataframes

אובייקטים אלו מורכבי מטבלאות המכילות שורות ועמודות, כמו באקסל, עם ערכים בתוך כל אחת מהמשבצות של הטבלה. לכל עמודה יש כותרת, המתארת את המידע באותה עמודה. שורות שונות בדרך כלל יבטאו תצפיות שונות, למשל - נתונים של נבדקים שונים או סבבים שונים של מטלה מסוימת עבור אותו נבדק. לפניכם דוגמה של מבנה נתונים המתאר את הנתונים הדמוגרפיים והציונים במדד תחושת מסוגלות עצמית עבור שישה נבדקים פיקטיביים.

```{r}
df1 = data.frame(subject = 1:6,
                city = c("Jerusalem","Haifa","Tel-Aviv","Eilat","Jerusalem","Tel-Aviv"),
                self_efficacy_score = c(2.3, 2.5, 2.1, 3, 2.2, 2.6))

print(df1)

```

ניתן לראות כי נבדק 1 גר בירושלים והוא בעל ציון 2.3 במדד תחושת המסוגלות העצמית. לעומת זאת נבדק 2 גר בחיפה והוא בעל ציון של 2.5 במדד המסוגלות העצמית.

כפי שניתן לראות בשורות הקוד המייצרות את הטבלה הנ"ל, טבלאות (Dataframes) הן אסופה של מספר וקטורים בעלי אותו אורך - כשלכל וקטור מוצמדת כותרת. במקרה הנ"ל הטבלה מורכבת מ3 וקטורים, כל אחד בעל 6 ערכים. בהתאם לכך שמדובר בוקטורים - כל עמודה חייבת להכיל סוג אחד של נתונים בלבד- numeric, charachtor, boolean וכו', אך עמודות שונות באותה טבלה יכולות להכיל סוגים שונים של מידע.

## יצירת מסגרת נתונים וחיתוכים

### יצירת טבלאות

הדרך הכי פשוטה לייצר טבלה היא באמצעות הפקודה data.frame(), שמאפשרת לנו לצרף יחד מספר וקטורים לכדי טבלה. זו לרוב לא תהיה הדרך בה נייצר את הטבלאות שאיתן נעבוד, אבל חושב להכיר גם אותה.

ניתן לייצר את מסגרת הנתונים באמצעות וקטורים שאנחנו מגדירים בתוך הפונקציה, כפי שעשינו בדוגמה לעיל, אך אפשר גם להשתמש בוקטורים שהגדרנו מראש. שימו לב: העמודות החדשות חייבות לנהיות באותו האורך של העמדות שכבר קיימות בטבלה. במידה ונדיר עמודה חדשה באמצעות וקטור קצר או ארוך יותר, נקבל הודעת שגיאה - אלא אם כן השתמשנו בוקטור בעל אורך שהוא בדיוק חצי, שליש, רבע וכו' מאורך הטבלה. במקרים כאלו התכנה תשכפל את הוקטור לפי מספר הפעמים הנדרש כדי להגיע לאורך התואם את מספר השורות בטבלה  

שורות הקוד הבאות מייצרות טבלה זהה לטבלה הקודמת. ערכו את הפונקציה המייצרת את הטבלה כך שתתווסף עמודה רביעית בשם "gender" ומלאו אותה בערכים לבחירתכם.
**

```{r exercise1, exercise=TRUE, exercise.eval = FALSE, exercise.cap = "יצירת טבלה", }

subjects = 1:6
city_per_subject = c("Jerusalem","Haifa","Tel-Aviv","Eilat","Jerusalem","Tel-Aviv")
self_efficacy_per_subject =  c(2.3, 2.5, 2.1, 3, 2.2, 2.6)

df1 = data.frame(subject = subjects,
                 city =  city_per_subject,
                 self_efficacy_score = self_efficacy_per_subject)

print(df1)
```

```{r exercise1-check}
grade_result(
  pass_if(~identical(names(.result), c("subject","city","self_efficacy_score","gender")))
)
```



### חיתוך באמצעות סוגריים מרובעים [,]

#### חיתוך משבצות בודדות

כשם שאנחנו יכולים לשלוף ערכים מתוך וקטור או לערוך ערך מסויים מתוכו, כך ניתן לעשות גם בטבלאות - אבל כיוון שלטבלאות יש 2 מימדים (שורות ועמודות) נצטרך להשתמש ב2 אינדקסים כדי להתייחס למשבצת ספציפית. במקרים כאלו האינדקס תמיד יתחיל בשורות (ערך ראשון משמאל) ואז יעבור לעמודות, כשבין שני האינדקסים מפריד פסיק.
למשל: החיתוך df1[2,3] מתייחס לשורה 2, עמודה 3 של הטבלה שנקראת df1.

 בשורות הקוד הבאות אנחנו שולפים את הערך של העיר בה גר הנבדק שבשורה השלישית ומדפיסים אותו ואז משנים את הערך של ציון תחושת המסוגלות העצמית של הנבדק בשורה הרביעית ל3.1  ומדפיסים את הטבלה הערוכה.

```{r df3, exercise=TRUE, exercise.eval = FALSE, exercise.setup = "prepare-df1"}

x = df1[3,2]
print(x)

df1[4,3] = 2
print(df1)
```

נסו בעצמכם: בחרו משבצת מסוימת שאתם רוצים לשלוף ותערכו את האינדקסים כך שיפנו למשבצת הנכונה. נסו לערוך את הערכים במשבצות שונות.


```{r logicals, echo = FALSE}
question(" מה קורה כשאתם משנים ערך אחד של עמודה מספרית לערך מסוג character ?",
         answer("מקבלים הודעת שגיאה"),
         answer("הערך הופך להיות מסוג numeric"),
         answer("העמודה מכילה גם ערכים מסוג numeric וגם ערך אחד מסוג character"),
         answer("העמודה כולה הופכת להיות מסוג character", correct = TRUE),
         allow_retry = TRUE
)
```

#### חיתוך תת-טבלאות

ניתן להשתמש בסוגריים מרובעים גם כדי לחתוך תת-טבלה מתוך הטבלה המקורית. בחיתוך כזה במקום לתת מספר בודד כאינדקס עבור השורות / העמודות נשתמש בוקטור המציין את מספרי השורות / עמודות שאנחנו רוצים לחתוך.

בנוסף, אנחנו יכולים גם לחתוך מתוך הטבלה שורה או עמודה שלמה באמצעות השארת אינדקס ריק.


כשמדובר בעמודות, ניתן גם לציין את העמודות שברצוננו לחתוך באמצעות שמות העמודות. במקום לשים באינדקס העמודות מספר, נספק את שם העמודה או וקטור של שמות העמודות אותן נרצה לחתוך.


לפניכם מספר דוגמאות:

```{r df4, exercise=TRUE, exercise.eval = FALSE, , exercise.setup = "prepare-df1"}

# (1)
df2 = df1[c(2,4,6),1:2] # Rows 2,4 and 6 of columns 1 and 2
print(df2)

# (2)
row1 = df1[1,] # All columns, row 1
print(row1)

columns_2_and_3 = df[,c(2,3)] # All rows, columns 2 and 3
print(columns_2_and_3)


city_subj_3_and_1 = df1[c(3,1),"city"] # The cities of subjects 3 and 1
print(city_subj_3_and_1)

subj_and_self_efficacy = df1[,c("subject","self_efficacy_score")]
print(subj_and_self_efficacy)

```



### פקד ה$

דרך נוספת לשלוף עמודה שלמה מתוך הנתונים נעזרת בפקד ה$ מלווה בשם העמודה. 


אם נבצע השמה לחיתוך שכזה נוכל לערוך עמודה קיימת או לייצר עמודה חדש - במידה ונשתמש בשם של עמודה קיימת הוקטור שנכניס ידרוס את העמודה ויחליף אותה. במידה ונשתמש בשם של עמודה שלא נמצאת במסגרת הנתונים נייצר עמודה חדשה בשם זה.


```{r df5, exercise=TRUE, exercise.eval = FALSE, , exercise.setup = "prepare-df1"}

# חיתוך עמודת הערים מתוך הטבלה
print(df1$city)

# יצירת עמודה חדשה המכילה נתוני גיל עבור הנבדקים
df1$age = c(21,35,42,32,24,19)

# דריסת עמודת הערים
df1$city = c("Haifa","Be'er-Sheva","Jerusalem","Be'er-Sheva","Jerusalem","Acre")


# יצירת עמודות על סמך עמודות קיימות
df1$age_in_months = df1$age * 12
df1$age_over_25 = df1$age > 25
df1$age_relative_to_mean = df1$age  -  mean(df1$age )


print(df1)

```


### טעינת טבלאות

עד עכשיו הגדרנו את הטבלאות שלנו בעצמנו. בפועל - רוב הטבלאות איתן נעבוד בR יכילו נתונים שנאספו על ידי תוכנות אחרות. כדי לנתח אותן בR נצטרך קודם כל לייבא את הנתונים לסביבת העבודה שלנו.

ישנן מספר פונקציות בR אשר מאפשרות לנו לטעון קובצים מפורמט CSV או XSLX (שני הפורמטים העיקריים לשמירת נתונים המיוצגים בטבלה), אך הדרך הידודותית ביותר למשתמש נעזרת בכלי של Rstudio שנועד להקל על ייבוא הקבצים.

כדי לגשת לכלי הייבוא, פתחו את R Rstudio ובחרו בלשונית "file" שבסרגל הכלים שבראש החלון של התוכנה. מכאן בחרו ב "Import Dataset" ובאחת מ2 האפשרויות הראשונות במידה ואתן מעוניינים לטעון קובץ CSV, או שלישית במידה והקובץ שלכם הוא מפורמט xslx.

לצורך תרגיל זה נתרגל טעינת קובץ מפורמט csv ולכן נבחר באפשרות השנייה (גם הראשונה אפשרית, אבל השנייה נוחה יותר) - "From Text (readr)..."

כשנבחר באפשרות זו ייפתח לנו חלון שיאפשר לנו לבחור קובץ לייבוא, לשלוט בכמה אפשרויות בתהליך הייבוא ולצפות בתצוגה מקדימה של הטבלה שאנחנו מייבאים. תהליך הייבוא קורה בכמה שלבים:

1. בחירת הקובץ: נלחץ על כפתור ה"Browse..." שבפינה הימנית עליונה של החלון. ייפתח עבורנו חלון בו נוכל לחפש ולבחור את הקובץ שאנו מעוניינים לייבא.

2. שינוי אפשרויות הייבוא בהתאם לקובץ שלנו: החלון מאפשר לנו להתאים את אופן הייבוא לאופן בו הנתונים שמורים בקובץ שלנו. למשל, הוא מאפשר לנו לדווח האם השורה הראשונה בקובץ שאנחנו מייבאים מכילה את הכותרות של העמודות או לא ולדלג על מספר שורות במידה והקובץ מכיל כמה שורות שאינן מכילות נתונים בתחילת הקובץ (באמצעות שדה ה"Skip"). בנוסף, החלון מאפשר לנו גם לקבוע מה יהיה שם האובייקט בו נרצה לשמור את הטבלה שאנחנו מייבאים, באמצעות השדה "Name".

3. ייבוא הקובץ. משערכנו את האפשרויות כך שהן תואמות לאופן בו נרצה לייבא את הנתונים מהקובץ נוכל לייבא אותו בפועל ב2 דרכים. הדרך הראשונה היא באמצעות לחיצה על כפתור "Import" שבתחתית החלון. כפתור זה יישם את הייבוא וייבא את הטבלה לסביבת העבודה שלנו.

בפועל, מה שקורה כאן הוא שהחלון מייצר שורות קוד שמנהלות את הייבוא לפי ההעדפות שלנו והכפתור מבצע את אותן שורות קוד. ניתן לראות את שורות הקוד בחלונית בתחתית החלון.

במקרים רבים לא נרצה רק לייבא את הטבלה לסביבת העבודה הנוכחית שלנו, אלא נרצה גם להעתיק את שורות הקוד האלו לקובץ הסקריפט, כך שבהרצה עתידית של הקובץ הקוד ייבצע את ייבוא הטבלה באופן אוטומטי. בשביל לדאוג לכך נוכל להעתיק את שורות הקוד מהחלונית ולהדביק אותן בקובץ הסקריפט שלנו.



תרגיל: ייבאו את הקובץ "XXX*" שבאתר המודל של הקורס.
ראשית, הוריד את הקובץ ושמרו אותו בתיקייה לבחירתכם, ואח"כ היעזרו בחלון הייבוא כדי לייצר את שורות הקוד שיאפשרו ייבוא תקין של הטבלה לסביבת העבודה שלכם.

העתיקו את שורות הקוד האלו לחלונית הקוד הבאה והריצו אותה. שמרו את הטבלה בסביבת העבודה בשם "table1"



```{r e-import, exercise=TRUE, exercise.eval = FALSE, exercise.cap = "ייבוא נתונים",exercise.lines = 5 }


print(head(table1))
```

```{r e-import-check}
#****
grade_result(
  pass_if(~identical(.result, c("subject","city","self_efficacy_score","gender")))
)
```

באופן דומה, אך מעט פשוט יותר - ניתן גם לייצא טבלאות לקבצי CSV.
הייצוא נעשה באמצעות הפקודה הבא:


```{r export, exercise=TRUE, exercise.eval = FALSE, , exercise.setup = "prepare-df1"}

write.csv(df1, "export dataframe example.csv")

```


בדוגמה זו ייצאנו את הטבלה df1  שנמצאת בסביבת העבודה שלנו מהתרגילים הקודמים ושמרנו אותה בתור קובץ CSV בשם  "export dataframe example.csv".

הקובץ יישמר בכתובת העבודה המוגדרת אצלכם בR כרגע. ניתן לברר ולשנותאת כתובת זו באמצעות הפונקציות הבאות:


```{r getwd, exercise=TRUE, exercise.eval = FALSE, , exercise.setup = "prepare-df1"}

working_directory = getwd()
print(working_directory)

# שינוי כתובת העבודה
# כרגע אנחנו מגדירים את הכתובת לפי הכתובת הנוכחית, ולכן היא לא תשתנה. החליפו את האובייקט 
# "working_directory" 
# בכתובת אחרת כדי לשנות את כתובת העבודה

new_working_directory = working_directory
setwd(new_working_directory)


```

לחלופין, במקום ךשנות את כתובת העבודה ניתן גם לספק לפונקציית הייצוא את הכתובת השלמה בה תרצו לשמור את הקובץ. במקרה כזה, פונקציית הייצוא תראה דומה ל:
```{r}
write.csv(df1, "C:/Users/one/Desktop/R files/DRL experiment/V3/data files/export dataframe example.csv")
```

בהתאם למיקום בו אתם מעוניינים לשמור את הקובץ


###  פונקציות שימושיות

ישנן מספר פונקציות בסיסיות בR שהינן ששימושיות מאוד לעיסוק בטבלאות. ברובן, הן מאפשרות לנו לגלות פרטים אודות הטבלה שלנו באופן פשוט ומיידי ולערוך אותה מכמה היבטים.

בקטע הקוד הבא ישנן מספר פונקציות המאפשרות לנו לגלות את מספר השורות והעמודות בטבלה שלנו. פונקציות אלו שימושיות במיוחד כשאנחנו צריכים להתייחס למימדים אלו בקוד, כך שבמקום לבדוק בעצמנו את אורך הטבלה ולהקליד את המספר המתאים נוכל להשתמש בקוד שיעשה את הבדיקה הזו עבורנו.

העתיקו לתחילת הקטע את השורות המייבאות את הקובץ 

```{r dimensions, exercise=TRUE, exercise.eval = FALSE, , exercise.setup = "prepare-df1"}

# מספר השורות והעמודות שבטבלה שייבאנו
dim(table1)

# מספר שורות
nrow(table1)

# מספר עמודות
ncol(table1)


# שימוש במספר השורות כדי לייצר עמודה חדשה  
table1$subject_index = 1:nrow(table1)

```

בנוסף, ישנן מספר פונקציות שיאפשרו לנו לבצע הצצה ראשונית אל תוך התוכן של הטבלה. פונקציות אלו שימושיות במיוחד כשאנחנו טוענים נתונים שאנחנו לא בטוחים איך הם מסודרים ו/או מה כל עמודה מכילה.

מתוכן, יש לנו פונקציות המאפשרות לבצע חיתוך מהיר של השורות הראשונות או האחרונות בטבלה (head ו tail), פונקציות שמסכמות לנו את הנתונים בכל עמודה ופונקציה ששולפת את שמות העמודות של הטבלה.

הפונקציה האחרונה לא רק שולפת את שמות העמודות, אלא גם מאפשרת לערוך אותן. בהמשך הקורס נלמד דרך נוחה יותר לעריכת שמות העמודות, אך שיטה זו הינה פשוטה ונפוצה.


```{r summary_and_names, exercise=TRUE, exercise.eval = FALSE, , exercise.setup = "prepare-df1"}

# שליפת השורות הראשונות. ברירת המחדל היא 6 שורות, אך ניתן גם לבקש מספר אחר של שורות
head(table1)
head(table1,4)

# סוף הטבלה
tail(table1)

# סיכום של כל העמודות בטבלה, בהתאם לסוג העמודה
summary(table1)


# שליפת שמות העמודות 
col_names = names(table1)
print(colnames)


# עריכת שמות העמודות
#**?

```


nrow()
names()
head()
tail()





פונקציות שימושיות לוקטורים:

mean()
sd()

range()
summary()

median()
quantile()


cor()












## תרגיל מסכם

טקסט והסבר

אפשר לתת שאלות שמציגות פתרון

1.  שאלה ראשונה

```{r ex1, exercise = TRUE}

```

```{r ex1-solution}
    a -> 1
```

2.  שאלות שמציגות רמזים

```{r ex2, exercise = TRUE}

```

```{r ex2-solution}
    b -> 5
    # the solution is here
```

::: {#ex2-hint}
**רמז:** כשיש רמז הוא מחליף פתרון גם אם הוגדר.
:::

## הגשת התרגיל

סיימת? מעולה! עכשיו הגיע הזמן להגיש את התרגיל.\
יש ללחוץ על הכפתור: Generate\
להעתיק את הטקסט שמופיע בחלון למטה ולהגישו במודל\
בהצלחה!

```{r context="server"}
learnrhash::encoder_logic()
```

```{r encode, echo=FALSE}
learnrhash::encoder_ui()
```
