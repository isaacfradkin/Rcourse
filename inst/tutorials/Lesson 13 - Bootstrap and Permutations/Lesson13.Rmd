---
title: "Lesson 13: bootstrap and permutations"
author: "Copyright 2024 Psychology Department. Hebrew University of Jerusalem. All rights reserved"
output:
  learnr::tutorial:
    progressive: true
    allow_skip: true
  

description: >
  <div style='direction: rtl;'>
  בלומדה זאת נלמד על ייצור התפלגות משוערת באמצעות בוטסטרפ ועל ביצוע מבחנים בשיטה אפרמטרית באמצעות מבחן פרמוטציות
  </div>
runtime: shiny_prerendered
---

<style>
h1, h2, h3, h4, h5, h6 {
  direction: rtl;
}
p {
  direction: rtl;
}
</style>


```{r setup, include=FALSE}
library(learnr)
library(gradethis)
library(Rcourse)
library(ggplot2)
library(dplyr)
library(ggcheck)

#need_for_cognition = data("need_for_cognition")
#need_for_cognition = nfc

tutorial_options()
knitr::opts_chunk$set(error = TRUE)

```

## Bootstrap

 משמעות המונח בוטסטרפ לקוחה מהמשפט ל"משוך את עצמך באמצעות רצועות המגפיים שלך". כלומר, להצליח בתנאים בלתי אפשריים, לייצר יש מאין. זה בדיוק מה שנעשה בשיעור זה. יש לנו מדגם וסטטיסטי שמתאר אותו. אך לרוע מזלינו הנחות בבסיס המבחנים שאנחנו יכולים לבצע (למשל מבחן Z או T) מופרות. לכן לא נוכל להסתמך על התפלגויות אלה ואנחנו נצטרך לייצר את ההתפלגות המלאה יש מאין.   
 באמצעות בוטסטרפ נוכל לדמות את ההתפלגות של המשתנה על סמך נתוני המדגם ללא צורך בהסתמכות על הנחות לגבי צורת ההתפלגות של המשתנה.
לצורך הסימולציה של התפלגות הבוטסטרפ נצטרך להשתמש בלולאות.  

נתחיל עם דוגמה פשוטה עם נתונים מדומים. אנחנו נרצה שהלולאה בעצם תחזור על עצמה ככמות האיטרציות הרצויה (למשל מינימום 1000, אבל במקרים רבים אולי נשאף ליותר חזרות). בכל חזרה של הלולאה נדגום מדגם חדש מתוך המדגם הקיים. שימו לב - הדגימה פה צריכה להיות עם החזרה. כך שיכול להיות שיווצר לנו מדגם שכולל רק תצפית אחת מתוך המדגם הרבה פעמים, מדגם שזהה למדגם המקורי והרבה מדגמים שמשלבים סט חלקי של תצפיות מתוך המדגם המקורי. לפני שנבנה את הלולאה בואו נראה איך נראית הדגימה עצמה, לשם כך נשתמש בפונקציה `sample`.   

תזכורת לגבי הארגומנטים (קלטים) שהפונקציה יכולה לקבל:  
`x` - וקטור המכיל נתונים מהם יש לבצע דגימה   
`size` - כמות התצפיות בכל דגימה (אם לא נכניס כלום הפונקציה תדמה מדגמים בעלי גודל זהה לx)   
`replace` - האם לבצע דגימה עם החזרה (TRUE) או בלי (FALSE)   
`prob` - מה ההסתברות של כל תצפית בנתונים המקוריים. הפונקציה תניח שכל תצפית היא בסבירות שווה.   

```{r}
# נתחיל עם מדגם היפוטתי פשוט מאוד
original_data <- c(1,2,3,4,5)
# נחשב את ממוצע המדגם
original_mean <- mean(original_data)
# ונציג אותו - זה הממוצע של המדגם המקורי שלנו
original_mean

# כדי לדמות מדגמים אשר מסתמכים על המדגם המקורי נדגום ממנו
# נשתמש בדגימה עם החזרה
sampled_data <- sample(original_data, replace = TRUE)
# נצפה במדגם שקיבלנו
sampled_data
# נחשב את הממוצע גם עבורו
sampled_mean <- mean(sampled_data)
# נדפיס
sampled_mean
```

```{r sample_q, echo = FALSE}
question("מה היה קורה אם היינו משתמשים בדגימה בלי החזרה?",
         answer("ממוצע המדגם שדגמנו היה זהה למדגם המקורי ללא שינויים נוספים לקוד", correct = TRUE,  message ="נכון. אם היינו רוצים לדגום מדגם חדש עם באותו הגודל של המדגם המקורי ללא החזרה היינו מקבלים מדגם שמכיל את כל התצפיות המקוריות אך לא בהכרח באותו הסדר. שימו לב זה יכול להיות שימושי בהמשך."),
         answer("המדגם המדומה היה תמיד זהה למדגם המקורים", message = " כמעט, אבל לא בדיוק. תהליך הדגמיה יכול לשנות את הסדר של הוקטור, זה לא ישפיע על הממוצע אבל זה יכול להשפיע על פעולות אחרות שאפשר לבצע עם וקטורים "),
         answer("הייתה מתקבלת שגיאה", message = "לא נכון, הפונקציה בהחלט מסוגלת לבצע דגימה כזאת, נסו ותראו."),
         answer("לא היה שום שינוי בתוצאה", message = "לא נכון, דגימה ללא החזרה הייתה גורמת לכך שהפונציה תמיד הייתה דוגמת 5 ערכים מתוך הוקטור המקורי אך לא היה ניתן לדגום  את אותו ערך פעמיים. לכן התוצאה הייתה תמיד וקטור שמכיל את כל הערכים המקוריים רק בסדר אחר.  "),
         allow_retry = TRUE
)
```

מעולה דימינו מדגם על בסיס הנתונים המקוריים, קיבלנו ממוצע אחר מהממוצע המקורים עבור הדגימה הזאת.  


### לולאת הבוטסטראפ
השלב הבא יהיה לחזור על התהליך 1000 פעמים, לפחות.  
מזל שלמדנו לולאות. בשיעורים הקודמים למדנו שכל חזרה על לולאה נקראית איטרציה, כדי לבצע מבחן בוטסטרפ צטרך לבצע מספר רב של איטרציות.   
בואו נוסיף את הלולאה:

```{r}
# נחזור לאותו המדגם עם הממוצע הידוע
original_data <- c(1,2,3,4,5)
original_mean <- mean(original_data)

# נקבע מה מספר החזרות
# נתחיל עם מספר קטן ונתקדם
n_iter = 5

# נפתח את הלולאה
# נשתמש פשוט בטווח של בין 1 למספר האיטרציות כדי לחזור התהליך
for (i in 1:n_iter){
  # כדי לדמות מדגמים אשר מסתכמים על המדגם המקורי נדגום ממנו
  # נשתמש בדגימה עם החזרה
  sampled_data <- sample(original_data, replace = TRUE)
  # נצפה במדגם שקיבלנו
  sampled_data
  # נחשב את הממוצע גם עבורו
  sampled_mean <- mean(sampled_data)
  # נדפיס
  print(sampled_mean)
}

```

הרצנו את הלולאה ועכשיו יכולנו לראות 5 מדגמים שונים אבל אנחנו עדיין לא שם. קשה לקרוא ל5 ערכים התפלגות ממש. אנחנו בעצם נצטרך לדמות את תפלגות הממוצע על פני חזרות רבות. לשם כך אנחנו צריכים לשמור את הממוצעים של המדגמים המדומים בוקטור.  

### שמירת והצגת התוצאות

עכשיו כשנתחיל לעבוד עם חזרות רבות יותר נצטרך לקחת בחשבון את `יעילות הריצה`. הביצוע של פעולה מספר רב יותר של פעמים יכולה להעמיס על המחשב. לכן נצטרך לקחת את זה בחשבון. למשל הדפסה של נתונים רבים בכל סיבוב של הלולאה תגרום לעומס ותאט את הפעילות. זה לא משפיע כמעט בכלל ב5 חזרות אבל ב10000 חזרות נרגיש את ההבדל. לכן נרצה לבחון את הקוד טוב טוב ולוודא שהריצה תהיה חלקה וכי אנחנו מדפיסים תוך כדי הלולאה רק את מה שמאוד הכרחי.  
כמו כן, ניקח בחשבון את היעילות בעת שמירת הנתונים.
ברמת העיקרון היינו יכולים ליצור וקטור ריק בתחילת הלולאה ולהוסיף לו ערך אחד בכל סיבוב. תהליך זה פחות יעיל חישובית, זה האמנם זניח כשמשתמשים ב5 איטרציות אבל ככל שנוסיף איטרציות תהיה תוספת משמעותית יותר של זמן הריצה. עדיף ליצור וקטור ריק שמכיל ערכים ככמות האיטרציות ולערוך ערך אחד כל פעם.  
לשם כך נשתמש בפונקציה `numeric()` אשר מקבלת את מספר הערכים הרצוי בוקטור ויוצרת וקטור מספרי המכיל אפסים.   
בואו נשלים את התהליך:

```{r}
# נחזור לאותו המדגם עם הממוצע הידוע
original_data <- c(1,2,3,4,5)
original_mean <- mean(original_data)

# נקבע מה מספר החזרות
# נתקדם למספר קצת יותר גדול
n_iter = 50
# ניצור את הוקטור שישמור את התוצאות
sampled_means <- numeric(n_iter)

# נפתח את הלולאה
# נשתמש פשוט בטווח של בין 1 למספר האיטרציות כדי לחזור התהליך
for (i in 1:n_iter){
  # דגימה
  sampled_data <- sample(original_data, replace = TRUE)
  # בכל איטרציה נשמור את הממוצע של המדגם המדומה
  sampled_means[i] <- mean(sampled_data)
}
# נדפיס את הממוצעים
sampled_means

# בעצם יהיה יותר קל להציג אותם כהיסטוגרמה 
# נשמור אותם בטבלה לטובת האיור
df <- data.frame(sampled_means=sampled_means)

#איור
hist_plot <- ggplot(df, aes(x=sampled_means))+geom_histogram(bins=5)
# נציג
hist_plot

# נוסיף לההתפלגות החדשה את הממוצע המקורי. 
hist_plot + geom_vline(xintercept = original_mean, color ="red")
```

אנחנו יכולים לראות שממוצע המחקר המקורי נופל יחסית במרכז ההתפלגות והערך גם יחסית שכיח בהתפלגות המדומה. הערכים הפחות נפוצים הם ערכים סביב 1 ו5, שכן כדי לקבל מדגם שהממוצע שלו הוא 1 היה צריך לדגום במקרה את הערך 1 מתוך המדגם המקורי 5 פעמים (או את הערך 5 במקרה של ממוצע של 5). ההסתברות שמדגם כזה יתקבל היא יחסית נמוכה אבל אפשרית ולכן השכיחות של הממוצעים בשתי קצוות ההתפלגות נמוכה.

`תרגיל`  
בתיבת הקוד למטה נתונים לכם נתונים מדומים של מדגם. כתבו קוד שהמחשב התפלגות בוטסטרפ לחציון המדגם. כתבו את הקוד כך שהלולאה תייצר לנו התפלגות על סמך 1000 חזרות. איירו את ההיסטוגרמה של התפלגות הבוטסטרפ של החציון בהשוואה לחציון המקורי במדגם המדומה. והדפיסו את הממוצע של התפלגות הבוטסטרפ

הערה - הימנעו מלהדפיס משתנים תוך כדי הלולאה, זה יאט את זמן הריצה ויבצע המון הדפסות.

```{r boot_loop_ex, exercise=TRUE, exercise.eval = FALSE }
set.seed(123)
# נדמה נתונים מהתפלגות נורמלית
original_data <- rnorm(30 , mean=0, sd=2)
# חישוב החציון 
original_median <- 
  
# נקבע את הפרמטרים של לולאת הבוסטסטרפ
n_iter <-
# ניצור את הוקטור שישמור את התוצאות
sampled_medians <- 
  
# בצעו את הלולאה כאן
  

# נדפיס את הממוצע 
round(mean(sampled_medians),2)
  
# בצעו את האיור
hist_plot <- 
  

```

```{r boot_loop_ex-solution}
set.seed(123)
original_data <- rnorm(30 , mean=0, sd=2)
# חישוב החציון 
original_median <- median(original_data)
  
# נקבע את הפרמטרים של לולאת הבוסטסטרפ
n_iter <- 1000
# ניצור את הוקטור שישמור את התוצאות
sampled_medians <- numeric(n_iter)
  
# בצעו את הלולאה כאן
for (i in 1:n_iter){
  sampled_data <- sample(original_data, replace = TRUE)
  sampled_medians[i] <- median(sampled_data)
  
} 

df = data.frame(sampled_medians=sampled_medians)
  
# בצעו את האיור
hist_plot <- ggplot(df, aes(x=sampled_medians)) + geom_histogram(bins=10) + geom_vline(xintercept = original_median, color ="red")

hist_plot

round(mean(sampled_medians),2)
```

```{r boot_loop_ex-check}
grade_result(pass_if(~identical(.result, -0.23),
  
    correct="כל הכבוד! הבוטסטרפ שלכם עבד מעולה!", 
  incorrect = "נסו שוב! זכרו להדפיס את הממוצע של התפלגות הבוטסטרפ"
)
```

### בדיקת השערות עם בוטסטרפ
עד כה הבנו איך לייצר את התפלגות הבוטסטרפ אבל עוד לא ממש למדנו איך להשתמש בה לצורך ביצוע של בדיקת השערות.  
הבוסטרפ בעצם מייצרת לנו התפלגות המשתנה, בעזרתה נוכל לחשב את רווח הסמך ולבחון למשל האם ממוצע המדגם שלנו שונה ממוצע המדגם תחת השערת האפס.  
בואו נראה דוגמאות:  

נתחיל עם דוגמה פשוטה שכן משתמשת בהתלפגות נורמלית ונבנה עליה.   
נניח שדגמנו את השכר של מי שלמד תכנות במהלך התואר הראשון 5 שנים לאחר סיום התואר. המטרה הייתה לבחון איך לימודי תכנות השפיעו על השכר, השערת האפס היא שחציון השכר של מי שלמד תכנות כחלק מלימודי התואר תהיה זהה לשכר החציוני   במשק (9100). בואו נבחן את ההשערה.  

```{r}
set.seed(123)
salary_data <- rnorm(300 , mean=11000, sd=8000)
# חישוב החציון 
salary_median <- median(salary_data)
  
# נקבע את הפרמטרים של לולאת הבוסטסטרפ
n_iter <- 1000
# ניצור את הוקטור שישמור את התוצאות
sampled_medians <- numeric(n_iter)
  
# בצעו את הלולאה כאן
for (i in 1:n_iter){
  sampled_data <- sample(salary_data, replace = TRUE)
  sampled_medians[i] <- median(sampled_data)
  
} 

# נחשב את רווח הסמך
# נקבע את רמת הבטחון
conf_level = 0.95

# נחשב את אלפא
alpha <- 1-conf_level

# נחשב הסף העליון והתחתון של רווח הסמך על סמך ההתפלגות 
lower <- quantile(sampled_medians, alpha / 2)
upper <- quantile(sampled_medians, 1 - alpha / 2)
# נציג
paste0("the bootastaped CI is: ", str(lower), " - ", str(upper), " ILS")


# נרצה  להשוות את ההתפלגות לשכר החציוני
reference <- 9100

# אם הערך לא נמצא בתוך הרווח נוכל לדחות את ההשערה
if (lower > reference | upper< referance){
  print("דחינו את השערת האפס ברמת בטחון של 95%")
} else {
  print("ערך הייחוס נמצא בתוך רווח הסמך, לא נוכל לדחות את השערת האפס")
}
 
 
# עכשיו נציג את האיור
hist_plot<-ggplot(data.frame(sampled_medians = sampled_medians), aes(x = sampled_medians)) + geom_histogram(binwidth = 300) +
  geom_vline(xintercept = salary_median, color = "red", linetype = "dashed") +
  geom_vline(xintercept = c(lower, upper), color = "green") +
  geom_vline(xintercept = reference, color = "blue") +
  geom_text(aes(x = salary_median, y = 10, label = "Sample Median"), color = "red", vjust = -1) +
  geom_text(aes(x = lower, y = 10, label = "Lower CI"), color = "green", vjust = -1) +
  geom_text(aes(x = upper, y = 10, label = "Upper CI"), color = "green", vjust = -1) +
  geom_text(aes(x = reference, y = 200, label = "Reference"), color = "blue", vjust = -1) + xlab("Sampled Medians") + ylab("Frequency")

hist_plot


```

אם נתבונן יחד באיור נוכל לראות את ההתפלגות עצמה, יחד עם החציון המקורי, השכר החציוני במשק (כחול) וגבולות רווח הסמך (ירוק)..

## Permutation test

### מבחן t למדגמים בלתי תלויים

### מבחן t לדגימות תלויות