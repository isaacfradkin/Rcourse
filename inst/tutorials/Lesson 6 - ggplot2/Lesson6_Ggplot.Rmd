---
title: "Lesson_6"
author: "Chen"
date: "2024-09-09"
output:
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---

<style>
h1, h2, h3, h4, h5, h6 {
  direction: rtl;
}
p {
  direction: rtl;
}
</style>


<!-- tutorial options and checking options - TODO set params -->
```{r setup, include=FALSE}
library(learnr)
library(gradethis)
library(Rcourse)
library(ggplot2)
library(dplyr)
#need_for_cognition = data("need_for_cognition")
#need_for_cognition = nfc

tutorial_options(
  exercise.timelimit = 60,
  # A simple checker function that just returns the message in the check chunk
  exercise.checker = function(check_code, ...) {
    list(
      message = eval(parse(text = check_code)),
      correct = logical(0),
      type = "info",
      location = "append"
    )
  }
)
knitr::opts_chunk$set(error = TRUE)

table2 = need_for_cognition %>%
  mutate(nfc_02 = 6 - nfc_02r,  # נהפוך את הקידוד של שלושת העמודות ההפוכות
         nfc_03 = 6 - nfc_03r,
         nfc_06 = 6 - nfc_06r,
         # נחשב את ממוצע ששת השאלות.
         # שימו לב - אפשר להשתמש בעמודות שיצרנו מוקדם יותר בתוך הפונקציה
         nfc    = (nfc_01 + nfc_02 + nfc_03 + nfc_04 + nfc_05 + nfc_06)/6,
         
         age_above_18 = age >=18,  # האם הנבדק מעל גיל 18
         
         gender = recode(gender, "male" = "M", "female" = "F"), # דריסת עמודת המגדר וקידוד מחדש של הערכים שנמצאים בה
                     # פונקציה זו מאפשר לנו לקודד מחדש עמודות עם מספר רמות - להחליף את הערכים המייצגים קבוצות שונות 
         
         # תקנון ציוני המדד ויצירת ציוני תקן - באופן שמתעלם מערכים חסרים
         nfc_Z_score = (nfc - mean(nfc,na.rm = T)) / sd(nfc, na.rm = T)  
         
         )
need_for_cognition = table2
```


## הצגה גרפית - מבוא

כאשר ננתח נתונים נוכל להסיק מסקנות מהניתוח הסטטיסטי, אבל כפי שלמדתם ותלמדו עוד בשיעור סטטיסטיקה, המבחנים הסטטיסטיים תמיד נתונים להטיות שונות ולכן בפני עצמם לא יוכלו לתת לנו תמונה מלאה של הנתונים שעבדנו איתם. לכן, במחקר בפסיכולוגיה נהוג להשתמש בהצגה גרפית, גם של התוצאות הסופיות במאמר מדעי וגם כדי להבהיר לעצמינו שאנחנו בדרך הנכונה, בהמון שלבים בדרך. היום נלמד איך לייצר תצוגה גרפית של נתונים בR באמצעות חבילה שנקראת ggplot2.

### מאפייני הגרף

לפני שנלמד להכיר את החבילה הזאת לעומק, יש אופציה פשוטה יותר שמגיעה יחד עם הפונקציות הבסיסיות של R. למשל הפונקציה _plot_.  בדוגמה למטה נגדיר נתונים פשוטים לדוגמה ונלמד על מאפייני הגרף. הגרפים הפשוטים ביותר לרוב כוללים שני מימדים, מימד אנכי (מעתה נקרא לו ציר x) ומימד אופקי (לו נקרא ציר y). כלומר, על מנת לייצר גרף נזדקק ברוב המקרים לשני וקטורים לפחות. בשיעור זה לא נלמד איך לייצר גרפים יותר מורכבים משני מימדים (כלומר לא נלמד על גרפים בתלת מימד, למרות בהם בהחלט אפשרות). אך אל דאגה, לא נהיה מוגבלים לשני משתנים בלבד בכל גרף. לכן בהמשך גם נלמד איך להוסיף עוד מידע מבלי להגדיל את כמות הצירים.

```{r}
x <- c(1, 2, 3, 4, 5)
y <- c(5, 4, 3, 2, 1)
plot(x, y)
```

בדוגמה זאת ראינו גרף שנקרא גרף פיזור, נלמד עליו עוד בהמשך. הגרף ממש מציג לנו את הנתונים הגולמיים, כל נקודה מייצגת תצפית בודדת ואת הערך שלה במשתנה x וy. למשל, התצפית הראשונה היא קיבלה ערך של 1 בx וערך של 5 בy וכן הלאה. 


אתם בטח שואלים את עצמכם איך בוחרים משתנה לצירX ולציר Y?  
התשובה היא שנהוג לשים את המשתנה המרכזי שבדקו במחקר (או התלוי) בציר Y. בשיעור סטטיסטיקה תלמדו עוד על המונחים הללו, אבל לטובת השיעור שלנו נגיד שהתוצא של המשתתפים בשאלון היא המשתנה המרכזי בנתונים הללו. 

## ggplot2

חבילה זאת היא החבילה הנפוצה ביותר להצגה גרפית בR והיא עובדת בשיטה שנקראית ״Grammar of Graphics״. כלומר, החבילה הזאת מייצרת עבורינו ״שפה״ המתאימה לעבודה עם יצוגים חזותיים של נתונים. כדי לעבוד עם חבילה זאת בסביבה שלכם בR תצטרכו להתקין אותה, לאחר ההתקנה בכל פעם שתרצו להשתמש במה שהיא מציעה תצטרכו לטעון אותה באמצעות הפקודה _library(ggplot2)_. כמו כן, חבילה זאת מתאימה לעבודה עם טבלאות (dataframe) ולא עם וקטורים בודדים כמו שראינו בדוגמה למעלה (אבל אתם כבר יודעים איך לייצר טבלאות מוקטורים ולכן זאת לא תהיה בעיה). 
חבילה זאת עובדת באמצעות ״שכבות״ של קוד שבונות לנו את הגרף.

לטובת זאת נשתמש בנתונים שהכרנו בשיעור הקודם need for cognition. בשיעור זה הנתונים יהיו קיימים מבלי שתעשו דבר, אך אם תרצו לעבוד עם הנתונים בסביבה שלכם תצטרכו לטעון אותם.


### שכבה ראשונה - הגדרת הצירים
השכבה הראשונה בסינטקס של `ggplot` היא למעשה שקופה, בה נגדיר בעיקר את טבלת הנתונים איתה נעבוד ואת העמודות שיהיו רלוונטיות לצירים השונים. את שם הטבלה נכניס ראשונה ואחריה נגדיר את הצירים על ידי שימוש בביטוי `aes` (שם קוד למילה ציר באנגלית - axis). למשל:  
ggplot(name_of_df, aes(x=name_of_x_col, y=name_of_y_col)  

ננסה לשחזר את האיור שפתחנו את השיעור איתו. שימו לב שדרוש פה מעבר לנתונים בצורת טבלה
```{r}
v1 = c(1, 2, 3, 4, 4)
v2 = c(5, 4, 3, 2, 1)
data_frame = data.frame(variable_1=v1, variable_2=v2)

ggplot(data_frame, aes(x=variable_1, y=variable_2))
```

אפשר לראות שנפתח איור? אך לא מופיע בו שום דבר, זאת כיוון שההגדרת ההצגה עצמה תגיע בשכבות הבאות.


### שכבה שניה - הגדרת סוג האיור
כמו שכבר הבנתם, בשיעור נכסה כמה סוגי גרפים. כלומר אפשר להציג את אותם נתונים בכמה דרכים שונות ובשכבה השניה נדרש לפרט איזה סוג של גרף נרצה לייצר. את זה נעשה על ידי קבוצת הפונקציות `geom()`.  


קודם כל נכיר את הפונקציה `geom_point()`, פונקציה שתוסיף לנו את הנקודות ותיצור לנו גרף פיזור כמו שראינו עם הפונקציה הבסיסית קודם לכן. יש בעצם לחבר את השכבות באמצעות הסימן `+` כפי שמודגם בקוד למטה.

```{r}
v1 = c(1, 2, 3, 4, 4)
v2 = c(5, 4, 3, 2, 1)
data_frame = data.frame(variable_1=v1, variable_2=v2)

ggplot(data_frame, aes(x=variable_1, y=variable_2))+ geom_point()
```

עכשיו שהבנו את העקרונות הבסיסיים של השפה הגרפית נוכל לצלול לעומק הנושא של ייצוגים גרפים. עכשיו נעבור לעבודה עם הנתונים האמיתיים, כעת נלמד להכיר סוגים שונים של גרפים ובעיקר איזה גרף מתאים לאיזה נתונים

### היסטורגרמה

נתחיל בגרף שמייצג נתונים של משתנה אחד - `ההיסטוגרמה` או _דיאגרמת שכיחות_
היסטוגרמה היא איור יוצא דופן מהבחינה שהוא מבוסס רק על משתנה אחד. אך הוא עדיין מורכב משני צירים שמתאר את ערך המשתנה (X) והשני שמתאר את השכיחות של אותו ערך.  
הפונקציה המייצרת איור זה נקראית `geom_histogram()`
נתחיל עם דוגמה פשוטה. בשיעורים הקודמים למדנו להכיר את הנתונים שלנו. נתחיל מלאייר את השכיחות של התשובות לשאלה הראשונה (nfc01).

```{r}
# נתחיל בהגדרת השכבה הראשונה עם משתנה בודד ונוסיף את השכבה השניה באמצעות +
ggplot(need_for_cognition, aes(x=nfc_01)) + geom_histogram()


```

אז קיבלנו פה איור ושתי אזהרות.  
האיור מציג לנו על ציר X את כל התשובות האפשריות על שאלה 1 - ערכים בין 1 ל5. בציר Y אנחנו רואים את השכיחות של כל תשובה. למשל אפשר לראות שהתשובה 1 ו5 היו הכי פחות שכיחות והתקבלו כל אחת פחות מ200 פעמים. לעומת זאת התשובה 3 הייתה הכי שכיחה והתקבלה יותר מ750 פעמים.  

עכשיו בואו ננסה להבין את ההזהרות שקיבלנו.   
נתחיל מההזהרה השניה, היא מודיעה לנו שכל הערכים ה"לא סופיים" מוסרים מן הגרף. הכוונה היא בעצם לכל ערך שאיננו מספר וניתן לפירוש על ידי הפונקציה. בנתונים שלנו קיימים ערכים חסרים והם הערכים שאינם מוצגים. אנחנו יכולים להסיר אותם כפי שלמדתם בשיעור הקודם, אבל התוצאה הגרפית תהיה זהה.  

ההזהרה הראשונה מתייחסת לאגומנט שניתן להכניס לפונקציה geom_histogram, בשם bins. הכוונה בbins היא מספר העמודות שמוצגות בהיסטוגרמה והפונקציה מכילה בתוכה ברירת מחדל של 30. כלומר, היא הייתה רוצה להציג 30 עמודות. אבל! יש לנו רק 5 ערכים שהשאלה הייתה יכולה לקבל ולכן היא מעלה שייתכן והתצוגה לא מיטבית. אנחנו יכולים לתקן זאת בקלות על ידי הכנסה של אחד משני ארגומנטים:

`bins` - כמות העמודות שיכללו בהיסטוגרמה
`binwidth` - רוחב העמודות (בכמות ערכים), כלומר אם נכניס ערך של 1 כל עמודה תשקף ערך 1. נסו אפשרויות שונות וראו כיצד הן משפיעות על התצוגה של הגרף.

```{r pass_hist_ex, exercise=TRUE, exercise.eval = FALSE}
ggplot(need_for_cognition, aes(x=nfc_01)) + geom_histogram()

```

בעיקרון בהיסטוגרמות העמודותאמורות להיות צמודות ללא רווחים.  
```{r hist_bins_q, echo = FALSE}
question(" איזה ערכים מביאים אותנו למצב בו ההיסטוגרמה רציפה ללא רווחים בין העמודות?",
         answer("bins=5 או binwidth=1", correct = TRUE),
         answer("bins=1 או binwidth=5", message = " כמעט, אבל הפוך, רוחב כל עמודה אמור להיות "),
         answer("bins=5 או binwidth=5", message = "מספר העמודות אכן צריך להיות 5, כמספר התשובות והאמנם גם עם האופציה הזאת נקבל גרף רציף אבל העמודות יתמזגו כיוון שהרוחב של כל עמודה גדול מ1."),
         answer("bins=1 או binwidth=1", message = "רוחב כל עמודה אכן צריך להיות 1, כמו ההפרש בין התשובות השונות אבל הגדרה של מספר העמודות של 1 תביא להצגה של עמודה אחת בלבד "),
         allow_retry = TRUE
)
```

`תרגיל`  
הוספו עמודה לטבלה שבה יאוכסן סכום הציונים של כל נבדק בשאלון והציגו את ההיסטוגמה של העמודה שיצרתם
```{r hist_ex, exercise=TRUE, exercise.eval = FALSE}
# חשבו כאן את הסכום
need_for_cognition$nfc_sum <-

# צרו כאן את האיור
# רמז - שימו לב לעמודות

```
```{r hist_ex-solution}
need_for_cognition <- need_for_cognition %>% mutate(nfc_sum  = (nfc_01 + nfc_02 + nfc_03 + nfc_04 + nfc_05 + nfc_06))
ggplot(need_for_cognition, aes(x=nfc_01)) + geom_histogram(binwidth=1)
```


### גרף עמודות
גרף עמודות (או _bar graph_) היא כנראה דוגמה קלאסית ופשוטה למה שעולה לכם כשאתם חושבים על גרף.  
איור עמודות יכול להיות דרך נוספת לייצר היסטוגרמה. כדי לייצר איור כזה נשתמש בפונקציה `geom_bar`. פונקציה זאת מקבלת ארגומנט אחד `stat`. ברירת המחדל כאן היא count כלומר, אנחנו ניתן לפונקציה רק משתנה אחד והיא תספור את השכיחות של כל ערך ותציג אותה בציר y.

למשל נחזור על הדוגמה עם השאלה הראשונה בשאלון:
```{r}
ggplot(data=need_for_cognition, aes(x=nfc_01)) +
+     geom_bar()

# שימו לב! זה שלא פירטנו כלום בפונקציה אומר שהיא השתמשה בברירת המחדל שלה:
# stat="count"
```

אבל זה בעצם לא שימוש נפוץ בפונקציה. 
לרוב זאת בעצם הדרך הפשוטה ביותר לייצג שני משתנים שאחד מהם הוא בסולם שמי והשני הוא בסולם סדר ומעלה (כלומר מספרי). אפשר גם כאן לייצג מה שנרצה, אך בדוגמאות אנחנו נתרכז בהצגת ממוצעים. לאחר שנחשב את הממוצע, נצטרך לפרט לפונקציה שעליה להשתמש בזהות של המשתנה בסולם שמי במקום בשכיחות. לכן נצטרך לפרט לה שstat="identity".

למשל בנתונים שלנו נוכל לשאול האם יש הבדלים מגדריים במענה על השאלות? נתחיל את הבירור משאלה 1. בואו נבנה את הגרף יחד.

```{r}
# קודם נחשב סיכום של הממוצעים
gender_ave <- need_for_cognition %>% group_by(gender) %>% summarise(mean_nfc_01=mean(nfc_01, na.rm=TRUE)) 
# שימו לב שדרושה הסרה של ערכים חסרים בשאלונים
ggplot(data=gender_ave, aes(x=gender, y=mean_nfc_01)) + geom_bar(stat="identity")


```
קיבלנו גרף עם הבדלים קטנים בין שלושת קבוצות המגדר

מה חסר פה לדעתכם? גרף העמודות בעצם מייצג לנו את הממוצע של תשובות השאלון בתוך כל מגדר, כלומר יש לנו הערכה של הממוצע. אבל כדי שנוכל ממש לקבל אומדן של ההבדלים כדאי להוסיף גם מדד של פיזור הנתונים. לרוב משתמשים בסטיית התקן, שכן היא אומדת את הפיזור ביחידות המקוריות. כדי להוסיף את אומדן זה לגרף נהוג להשתמש בקוי סטיה או _error bars_. את ההוספה הזאת נוכל לעשות באמצעות הוספה של שכבה שלישית עם הפונקציה `geom_errorbar`.  
נכניס לפונקציה זאת שני ארגומנטים:  
1. aes - צירים, אבל הפעם הצירים מפרטים את הערך המינימלי והמקסימלי. הערכים הללו צריכים להיות הממוצע עם חיסור וחיבור של סטיית תקן אחת בהתאם.
2.width - רוחב התוסף. אם לא נגדיר לו רוחב הוא יהיה ברוחב הגרף כולו וזה פחות אסתטי ולכן נוסיף.

נחזור על אותה דוגמה:
```{r}
gender_ave <- need_for_cognition %>% group_by(gender) %>% summarise(mean_nfc_01=mean(nfc_01, na.rm=TRUE))

# עכשיו גם נחשב את סטיית התקן הרלוונטית
 sd <- sd(need_for_cognition$nfc_01, na.rm=TRUE)

ggplot(data=gender_ave, aes(x=gender, y=mean_nfc_01)) + geom_bar(stat="identity") +
geom_errorbar(aes(ymin=mean_nfc_01-sd, ymax=mean_nfc_01+sd), width=.2)

```

עכשיו אנחנו יכולים לראות שהפיזור גדול מההבדלים בין הקבוצות. אנחנו לא נעסוק בהסקה סטטיסטית בשיעור זה, אבל כדי שתוכלו לקבל טעימה מאיך נשתמש בהצגה גרפית בליווי מסקנות סטטיסטית, אפשר להגיד שבהינתן פיזור שגדול מהבדלי הממוצעים הסבירות שיש הבדלים משמעותיים תלויי מגדר בתשובות לשאלה הראשונה נמוכה מאוד.

`תרגיל`  
צרו גרף עמודות עם סטיית תקן המציג את הציון החציוני של שאלה 5 לפי תוצאות בדיקת הקשב בשאלון. כלומר השוו בין החציונים של מי שעבר את בדיקת הקשב (1) ומי שלא (0). 
בונוס: שנו את התוויות של משתנה הקשב

```{r bar_ex, exercise=TRUE, exercise.eval = FALSE}
# יצירת טבלה חדשה עם החציונים
attention_ave <-

# חישוב סטיית התקן
  
# צרו כאן את האיור


```
```{r bar_ex-solution}
# יצירת טבלה חדשה עם החציונים
attention_ave <- need_for_cognition %>% group_by(attention_check) %>% summarise(med_nfc_05=median(nfc_05, na.rm=TRUE))

# הבונוס!
attention_ave$attention_check <- as.factor(attention_ave$attention_check)
levels(attention_ave$attention_check) <- c("Fail", "Pass")

# חישוב סטיית התקן
 sd <- sd(need_for_cognition$nfc_05, na.rm=TRUE)
 
# צרו כאן את האיור
ggplot(data=attention_ave, aes(x=attention_check, y=med_nfc_05)) + geom_bar(stat="identity") +
geom_errorbar(aes(ymin=med_nfc_05-sd, ymax=med_nfc_05+sd), width=.2)

```

### גרף קופסא
נתקדם עכשיו צעד אחד קדימה מעבר להצגה של ממוצעים וסטיות תקן בלבד אל הצגה מלאה יותר שה סטטיסטיקה התיאורית. גרף קופסא או _box plot_ מאפשר לנו להציג כל מיני מאפיינים של הגרך.  
גרף זה גם כן מציג לנו עמודות המחולקות לפי משתנה (לרוב שמי) של משתנה נוסף שהוא מספרי. אבל הפעם עם הרבה יותר מידע.
נתחיל עם להציג גרף כזה באמצעות הפונקציה `geom_boxplot` ואז נלמד את פירושו.

```{r}
ggplot(data=need_for_cognition, aes(x=gender, y=nfc_01)) + geom_boxplot()

```

כמו ששמתם כל עמודה מורכבת מריבוע שחצוי באמצע ושני זנבות. הקצה של כל זנב מסמן את הערך המינילי (למטה) והמקסימלי (למעלה). גבולות הקופסא מראות לנו את החלוקה לרבעונים. החלק התחתון של הקופסא הוא הטווח של הרבעון השני, כלומר הזנב התחתון כולו הוא הרבעון הראשון. בהתאם הריבוע העליון מייצג את הטווח של הרבעון השלישי והזנב העליון את הרביעי. הקו המודגש באמצע מייצג אם כך את החציון.

```{r box_plot_q, echo = FALSE}
question("מה אנחנו יכולים ללמוד מהגרף הקודם על תיאור הנתונים של מי שהחליטו לא לציין את מגדרם?",
         answer("הטווח המקסימלי של משתתפים אלה נמוך יותר ", message="זה נכון, נראה שלא היו משתתפים בקבוצה זאת שדרגו 5, אבל יש תשובה יותר מתאימה"),
         answer("החציון הוא גם הערך המקסימלי של הרבעון השלישי", message = " זה נכון שהגרף מראה לנו שבנתונים אלה אין הפרדה בין הרבעון השלישי והשני (בגלל מיעוט הערכים הייחודיים שקיימים בנתונים), אבל יש תשובה יותר נכונה. "),
         answer("החציון של קבוצה זאת שווה לחציון של שתי הקבוצות האחרות", message = "זה נכון, הערך החציוני הוא 3 בכל הקבוצות, אבל יש תשובה יותר נכונה."),
         answer("כל התשובות נכונות", correct = TRUE),
         allow_retry = TRUE
)
```

### גרף פיזור
עכשיו נחזור לאיורים עם שני משתנים מספריים. למדנו כבר לייצר גרף כזה, אך עכשיו אנחנו נלמד איך להרחיב אותו. 
למטרה זאת יכול להיות שימושי לאכסן את האובייקט רב השכבות של ggplot במשתנה. אכסון של אובייקט הגרף במשתנה יאפשר לנו גמישות, כך שנוכל להוסיף למאפיינים של גרף שכבות נוספות ולבצע עריכות שונות על הגרף. למשל נגדיר גרף שנקרא scatter_plot:

```{r}
# נחשב את הסכום של כל השאלות
nfc_only = select(need_for_cognition, contains("nfc"))
need_for_cognition$nfc_sum <- rowSums(nfc_only, na.rm = TRUE)

# נגדיר את האיור במשתנה
scatter_plot <- ggplot(need_for_cognition, aes(x=age, y=nfc_sum))+ geom_point()

# כדי להציג את הגרף נצטרך לקרוא למשתנה
scatter_plot
```

### ערכים קיצוניים
אוי לא, יש לנו כאן בעיה. גם אתם שמתם לב?
רוב הגילאים מתהם בין 20-50 אבל יש שני משתתפים שהגילאים שלהן לא הגיוניים. 
הערך הבולט ביותר הוא המשתתף הבודד שהכניס שהגיל שלו הוא 150. כלומר, או שדרקולה הסתנן לנו למחקר או שיש לנו במחקר ערך קיצוני טעותי.  
הערך הפחות בולט אך לא פחות בלתי אפשרי הוא משתתף שהגיל שלו הוא פחות מ0.  
בואו נסיר את הערכים הקיצוניים ונציג שוב:

```{r}
# הסרת ערכים קיצוניים
need_for_cognition <- filter(need_for_cognition, age<90 & age>10)

# נגדיר את האיור במשתנה
scatter_plot <- ggplot(need_for_cognition, aes(x=age, y=nfc_sum))+ geom_point()

# כדי להציג את הגרף נצטרך לקרוא למשתנה
scatter_plot
```
אוקיי הרבה יותר טוב.
אבל מה עם הערכים הקיצוניים של סכום השאלות?

`תרגיל`  
חשבו מה הם הערכים הקיצוניים של הסכום והסירו אותם והציגו את הגרף שוב.
```{r outlier_ex, exercise=TRUE, exercise.eval = FALSE}
# הסירו כאן את הערכים הקיצוניים
need_for_cognition <-

# צרו כאן את האיור


```
```{r outlier_ex-solution}
# הסירו כאן את הערכים הקיצוניים
need_for_cognition <- filter(need_for_cognition, nfc_sum>0)

# צרו כאן את האיור
scatter_plot <- ggplot(need_for_cognition, aes(x=age, y=nfc_sum))+ geom_point()

# כדי להציג את הגרף נצטרך לקרוא למשתנה
scatter_plot

```
```{r outlier_ex-check}
"הערכים הקיצוניים הטעותיים שיש לנו במקרה זה הם 0 כיוון שהדירוג הנמוך ביותר שיכול להתקבל הוא 6 (1 בכל תשובה). הסיבה שיש 0 בנתונים היא בגלל שהם בעצם חסרים וחישבנו את הסכום כך שיתעלמו מערכים חסרים אך לא יסירו אותם. ערכים קיצוניים שאינם בהכרח טעותיים הם 6 ו30, התשובות הקיצוניות ביותר שיכולות להתקבל. אבל זאת לא בהכרח טעות ולכן נשאיר אותם."
```

### מגמות לינאריות
במקרה של גרף פיזור, אחד השימושים הנפוצים יותר הם הצגות של מגמות לינאריות. אולי עוד לא נחשפתם למושג וזה בסדר גמור. קורלציה על שם פירסון, או מתאם בין שני משתנים הוא מדד לקשר הלינארי בינהם. המשמעות של המונח לינארי בקצרה, היא קשר בין שני המשתנים שניתן לייצג על ידי קו ישר. הפונקציה שמחשבת ומוסיפה את הקו הישר שמתאר את הקשר נקראת `geom_smooth()`, שכן היא מייצגת קוים חלקים, אך במקרה זה נצטרך לפרט לה איזה קו שמתאר את הנתונים נרצה להוסיף, כלומר לפרט את השיטה בה יותאם הגרף. עבור קו ישר נבחר בlm שהוא קיצור של linear model. להלן דוגמה:

```{r}
scatter_plot <- ggplot(need_for_cognition, aes(x=age, y=nfc_sum)) + geom_point() 

# כדי להציג את הגרף נצטרך לקרוא למשתנה
scatter_plot + geom_smooth(method="lm")

# אפשר היה גם ככה כמובן
ggplot(need_for_cognition, aes(x=age, y=nfc_sum)) + geom_point() + geom_smooth(method="lm")
```

שימו לב! את השיטה יש להכניס כמחרוזת, כך הפונקציה יכולה לפרש אותה. ארגומנט חשוב נוסף שכדאי להכיר הוא se, הכוונה בse היא בעצם אומדן לסטיית התקן מהקו. אם נגדיר FALSE, יופיע קו ללא סטיית תקן.  

`תרגיל`
ייצרו את אותו גרף שראיתם בדוגמה ללא סטיית התקן והציגו אותו.
```{r smooth_ex, exercise=TRUE, exercise.eval = FALSE}


```

```{r smooth_ex-solution}
# נתונים:

scatter_plot <- ggplot(need_for_cognition, aes(x=age, y=scores)) + geom_point() + geom_smooth(method="lm", se=FALSE)

scatter_plot

```

### הוספת מימד שלישי לגרף
אז כמו שהבנתם בהדרכה זאת נישאר מוגבלים לשני צירים, אבל זה לא יגביל אותנו מלהציג יותר מ2 משתנים. ניתן להוסיף משתנה שלישי שיתבטא בצבע. כדי לבצע זאת נוסיף להגדרת הצירים (על ידי הפונקציה aes) את הארגומנט col, בה נכניס את השם של הטור שנרצה שיבטא הצבע. זה יכול להיות משנתה מסוג פקטור, כמו בדוגמה למטה:
```{r}
scatter_plot <- ggplot(need_for_cognition, aes(x=age, y=nfc_sum, col=gender)) + geom_point()
# עכשיו נוכל להציג את הגרף עם כמה הצבעים,    
scatter_plot
# וגם עם שתי מגמות לינאריות
scatter_plot + geom_smooth(method="lm")
```
שימו לב! התוכנה מייצרת לנו אוטומטית מקרא, שמסביר לנו איזה צבע מייצג איזה קטגוריה. המקרא הזה נקרא באנגלית legend.

עכשיו ברור לכם למה קיבלנו טווח כל כך קטן של אלה שלא דיווחו על מגדרם? יש ממש מעט כאלה. כנראה שאלה גם סוג של ערכים קיצוניים שעדיף היה להסיר מהניתוחים.

מה יקרה אם נרצה לחלק את הצבעים עם משתנה רציף?
בואו נראה אם יש הבדל במגמה הלינארית של גיל וסכום לפי התשובה הראשונה.

```{r}
scatter_plot <- ggplot(need_for_cognition, aes(x=age, y=nfc_sum, col=nfc_01)) + geom_point()

# וגם עם  מגמה לינאריות
scatter_plot + geom_smooth(method="lm")
```

שמתם לב שכאן המקרא רציף?
כמו כן המגמה הלינארית במקרה זה לא מופרדת לרמות השונות. אם היינו רוצים לעשות זאת המשתנה צריך להיות פקטור ולא מספרי.
  
למה דווקא צבע?
לא חייבים להשתמש בצבע, אפשר גם להשתמש בגודל (size) או בצורה של העיגולים (shape) או גם וגם. פוטנציאלית אפשר להציג כך אפילו יותר משלושה משתנים.

`תרגיל`
הציגו את הגרף פיזור של גיל וסכום השאלות בו הצבע מסמן את המגדר של המשתתפים (שימו לב, האם צריך להסיר משהו?) וגודל מסמל את התשובה לשאלה הראשונה
```{r col_size_scatter_ex, exercise=TRUE, exercise.eval = FALSE}


```

```{r col_size_scatter_ex-solution}
need_for_cognition <- filter(need_for_cognition, !is.na(gender))

scatter_plot <- ggplot(need_for_cognition, aes(x=age, y=nfc_sum, col=gender, size =nfc_01)) + geom_point()
# עכשיו נוכל להציג את הגרף עם כמה הצבעים,    
scatter_plot  

```

## התאמות ותצוגה 
### גבולות הגרף
אחת מההתאמות הנפוצות שאולי נרצה לעשות היא התאמה של הגבולות, של מה הערך הכי נמוך ומה הערך הכי גבוהה שיופיע בכל ציר. התוכנה תגדיר את גבולות הגרף אוטומטית. אך למשל אם נרצה להציג משתנה שהינו בעל ערכים חיוביים בלבד והערך המינימלי שתבחר התוכנה להציג יהיה נמוך מ0 נרצה לשנות זאת, שכן אין משמעות לחלק זה בגרף. כדי לשנות את הגבולות נוכל להשתמש בפונקציות:
`ylim()`
`xlim()`
כל אחת מצפה לקבל וקטור שיכיל את הערך המינימלי והמקסימלי לאותו ציר. למשל:
```{r}
scatter_plot <- ggplot(need_for_cognition, aes(x=age, y=nfc_sum)) + geom_point()  + geom_smooth(method="lm")
scatter_plot +xlim(c(0, 35)) + ylim(c(0, 100))
```

שמתם לב למודליות של ההשמה של הגרף במשתנה? הוספנו לגרף עוד שכבה מבלי לשנות את הנתונים המקוריים שלו. עם זאת, שימו לב, אם תגדירו טווח קטן מידי, כל הנקודות שנמצאות מחוץ לטווה זה לא יוצגו.
### צבע וגודל
המשתנים שאתם מנסים להציג הם למשל הצבע של מילה שהוצגה? והייתם רוצים שהנקודות יופיעו בירוק במקום בכחול? האמת היא שכדי לשנות צבע וצורה צריך לבצע שינוי בפונקציה המקורית שמייצרת את הנקודות:
```{r}
scatter_plot <- ggplot(need_for_cognition, aes(x=age, y=nfc_sum)) + geom_point(col="green", size=3)  + geom_smooth(method="lm")
```
את הצבע נשנה על ידי הארגומנט col, בggplot יש שתי אפשרויות לפירוט הצבע. האפשרות הראשונה היא לפי שם והאפשרות השניה היא לפי מאפייני הצבע, צירוף של אותיות ומספרים .

אופציה נוספת היא שימוש ב״פלטות״ מוכנות של צבעים שR  הכינה לכם מראש על ידי הוספת הפונקציה  scale_colour_brewer() והגדרה של פלטת הצבעים הרצויה. למשל:
```{r}
scatter_plot <- ggplot(need_for_cognition, aes(x=age, y=nfc_sum, col=gender)) + geom_point()  
scatter_plot + scale_colour_brewer(palette = "Set1")
```
בשיטה הזאת לא צריך לבחור כל צבע בנפרד אלא אפשר לבחור פלטה מוכנה.

תוכלו למצוא פרטים נוספים ואת שמות כל הצבעים בקישור:
[colors](http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/)

### כותרות ושמות הצירים
פן חשוב נוסף של הצגה גרפית הוא האינפורמטיביות של הגרף. האמנם אנחנו כרגע ציירנו את הגרף ואנחנו יודעים בדיוק מה יש בו, אבל אם נרצה לשלוח את הגרף למרצה לסטטיסטיקה נצטרך שהוא גם יוכל להבין אותו מבלי לקרוא את הקוד שלנו. כמה פונקציות שימושיות בהקשר הזה:
`ggtitle` - מגדירה את הכותרת הכללית, ניתן להכניס לה ארגומנט נוסף של subtitle, כלומר תת כותרת שתוצג מתחת לכותרת הראשית.
`xlab` - כותרת של ציר הx
`ylab` - כותרת של ציר הy
 עריכה של הכותרות יכולה להיעשות במרוכז על ידי הפונקציה `labs()` (כלומר קיצור של המילה labels) כמו בקוד מטה 
 
```{r} 
scatter_plot <- ggplot(need_for_cognition, aes(x=age, y=nfc_sum)) + geom_point(col="green", size=3) + geom_smooth(method="lm")

scatter_plot + labs(title="Need for cogintion score by age", subtitle="From class dataset", y="NFC score", x="Age (years)", caption="linear graph")
``` 

אפשר גם להכניס כותרת למקראים השונים למשל על ידי col=“Names” או size=“Length”
להיכנס לשינוי הלגנד והסדר של ופוזישן שלו?
### עיצוב 
התוכנה גם מציעה לנו לשנות את העיצוב הכולל של הגרף, על ידי בחירת פונקציה מקבוצת הפונקציות של theme. למשל:
```{r} 
scatter_plot <- ggplot(need_for_cognition, aes(x=age, y=nfc_sum)) + geom_point(col="green", size=3)  + geom_smooth(method="lm")
scatter_plot + theme_classic()
```
תוכלו למצוא את מגוון העיצובים כאן:
[themes](https://ggplot2.tidyverse.org/reference/ggtheme.html)

רוצים ללמוד עיצובים מתקדמים שלא הראנו לכם פה?  
אין בעיה, עכשיו אתם יודעים מספיק כדי להשתמש במדריכים של ggplot2. חיפוש פשוט בגוגל של המילה ggplot2 וסוג הגרף שאתם רוצים לייצר יביא אתכם למדריך מפורט שמראה את כל האפשרויות. למשל, מצורף פה קישור למדריך המפורט של ההיסטוגרמות.  
[histogram manual](http://www.sthda.com/english/wiki/ggplot2-histogram-plot-quick-start-guide-r-software-and-data-visualization)  
כשתבצעו את החיפוש בגוגל יהיו כמובן הרבה תוצאות, לדעתי המדריכים של STHDA הכי טובים, אבל תמצאו את מה שעובד לכם!

## תרגיל מסכם
`שאלה 1`  
חוקר העלה השערה שישנם הבדלים מגדריים שהאנליזות הקודמות שלנו לא גילו. לטענתו ההבדלים המגדריים מתבטאים ביחס בין השאלות הראשונות לאחרונות. 
חשבו כעת את מדד הראשוניות של השאלון. מדד הראשוניות הוא ההפרש בין סכום שלושת השאלות הראשונות לסכום שלושת השאלות האחרונות כפול 100. 
הציגו את הקשר הלינארי (כולל קו המגמה) בין מדד הראשוניות לסכום הפשוט של כל השאלות. הציגו בנפרד את הנשים והגברים (בצבעים שונים).
```{r final_ex_1, exercise=TRUE, exercise.eval = FALSE}
# חשבו את מדד הראשוניות והוסיפו אותו לנתונים
need_for_cognition$prime <-


```

```{r final_ex_1-solution}
# חשבו את מדד הראשוניות והוסיפו אותו לנתונים
nfc_only = select(need_for_cognition, contains("nfc"))
need_for_cognition$prime <- (rowSums(nfc_only[1:3], na.rm = TRUE) - rowSums(nfc_only[4:6], na.rm = TRUE))*100

scatter_plot <- ggplot(need_for_cognition, aes(x=nfc_sum, y=prime, col=gender)) + geom_point() + geom_smooth(method = "lm")
# עכשיו נוכל להציג את הגרף עם כמה הצבעים,    
scatter_plot  

```

`שאלה 2`  
החוקרת שאספה את הנתונים לא השתכנעה שהבדלים מגדריים הם הגורם. לטענתה יותר סביר שמדד הראשוניות מושפע מרמת הקשב של המשתתפים לשאלון.  
ציירו לה איור קופסא שידגים איך הנתוני מדד הראשוניות נראים כאשר הם מחולקים לפי בדיקת הקשב (על ציר X) ולפי מגדר (צבע)
```{r final_ex_2, exercise=TRUE, exercise.eval = FALSE}


```

```{r final_ex_2-solution}
box_plot <- ggplot(need_for_cognition, aes(x=attention_check, y=prime, col=gender)) + geom_boxplot()
# עכשיו נוכל להציג את הגרף עם כמה הצבעים,    
box_plot  

```

## הגשת התרגיל
  סיימת? מעולה! עכשיו הגיע הזמן להגיש את התרגיל.  
  יש ללחוץ על הכפתור:  Generate  
  להעתיק את הטקסט שמופיע בחלון למטה ולהגישו במודל  
  בהצלחה!

```{r context="server"}
learnrhash::encoder_logic()
```

```{r encode, echo=FALSE}
learnrhash::encoder_ui()
```

