---
title: "Lesson_6"
author: "Chen"
date: "2024-09-09"
output:
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---

<style>
h1, h2, h3, h4, h5, h6 {
  direction: rtl;
}
p {
  direction: rtl;
}
</style>


<!-- tutorial options and checking options - TODO set params -->
```{r setup, include=FALSE}
library(learnr)
library(gradethis)
library(ggplot2)
library(dplyr)

tutorial_options(
  exercise.timelimit = 60,
  # A simple checker function that just returns the message in the check chunk
  exercise.checker = function(check_code, ...) {
    list(
      message = eval(parse(text = check_code)),
      correct = logical(0),
      type = "info",
      location = "append"
    )
  }
)
knitr::opts_chunk$set(error = TRUE)
```
## הצגה גרפית - מבוא

כאשר ננתח נתונים נוכל להסיק מסקנות מהניתוח הסטטיסטי, אבל כפי שלמדתם ותלמדו עוד בשיעור סטטיסטיקה, המבחנים הסטטיסטיים תמיד נתונים להטיות שונות ולכן בפני עצמם לא יוכלו לתת לנו תמונה מלאה של הנתונים שעבדנו איתם. לכן, במחקר בפסיכולוגיה נהוג להשתמש בהצגה גרפית, גם של התוצאות הסופיות במאמר מדעי וגם בהמון שלבים בדרך. היום נלמד איך לייצר תצוגה גרפית של נתונים בR באמצעות חבילה שנקראת ggplot2.

### מאפייני הגרף

לפני שנלמד להכיר את החבילה הזאת לעומק, יש אופציה פשוטה יותר שמגיעה יחד עם הפונקציות הבסיסיות של R. למשל הפונקציה _plot_.  בדוגמה למטה נגדיר נתונים פשוטים לדוגמה ונלמד על מאפייני הגרף. הגרפים הפשוטים ביותר לרוב כוללים שני מימדים, מימד אנכי (מעתה נקרא לו ציר x) ומימד אופקי (לו נקרא ציר y). כלומר, על מנת לייצר גרף נזדקק ברוב המקרים לשני וקטורים לפחות. בשיעור זה לא נלמד איך לייצר גרפים יותר מורכבים משני מימדים ולכן בהמשך גם נלמד איך להוסיף עוד מידע מבלי להגדיל את כמות הצירים.

```{r}
x <- c(1, 2, 3, 4, 5)
y <- c(5, 4, 3, 2, 1)
plot(x, y)
```

בדוגמה זאת ראינו גרף שנקרא גרף פיזור, נלמד עליו עוד בהמשך. הגרף ממש מציג לנו את הנתונים הגולמיים, כל נקודה מייצגת תצפית בודדת ואת הערך שלה במשתנה x וy. למשל, התצפית הראשונה היא קיבלה ערך של 1 בx וערך של 5 בy וכן הלאה. 

## ggplot2

חבילה זאת היא החבילה הנפוצה ביותר להצגה גרפית בR והיא עובדת בשיטה שנקראית ״Grammar of Graphics״. כלומר, החבילה הזאת מייצרת עבורינו ״שפה״ המתאימה לעבודה עם יצוגים חזותיים של נתונים. כדי לעבוד עם חבילה זאת בסביבה שלכם בR תצטרכו להתקין אותה, לאחר ההתקנה בכל פעם שתרצו להשתמש במה שהיא מציעה תצטרכו לטעון אותה באמצעות הפקודה _library(ggplot2)_. כמו כן, חבילה זאת מתאימה לעבודה עם טבלאות (dataframe) ולא עם וקטורים בודדים כמו שראינו בדוגמה למעלה (אבל אתם כבר יודעים איך לייצר טבלאות מוקטורים ולכן זאת לא תהיה בעיה). 
חבילה זאת עובדת באמצעות ״שכבות״ של קוד שבונות לנו את הגרף.

לטובת זאת נשתמש בנתונים שהכרנו בשיעור הקודם need for cognition
** להבין איך לטעון**

### שכבה ראשונה - הגדרת הצירים
השכבה הראשונה בסינטקס של ggplot היא למעשה שקופה, בה נגדיר בעיקר את טבלת הנתונים איתה נעבוד ואת העמודות שיהיו רלוונטיות לצירים השונים. את שם הטבלה נכניס ראשונה ואחריה נגדיר את הצירים על ידי שימוש בביטוי aes (שם קוד למילה ציר באנגלית - axis). למשל:  
ggplot(name_of_df, aes(x=name_of_x_col, y=name_of_y_col)  

אתם בטח שואלים את עצמכם איך בוחרים משתנה לצירX ולציר Y?  
התשובה היא שנהוג לשים את המשתנה המרכזי שבדקו במחקר (או התלוי) בציר Y. בשיעור סטטיסטיקה תלמדו עוד על המונחים הללו, אבל לטובת השיעור שלנו נגיד שהתוצא של המשתתפים בשאלון היא המשתנה המרכזי בנתונים הללו. 
```{r}
scores = c(80.2,75.5,60,75.5,75.5,75.5,84,80.2,94)
age = c(21,22,23,56,45,18,36,29,33)
need_for_cognition = data.frame(scores=scores, age=age)

ggplot(need_for_cognition, aes(x=age, y=scores))
```

אפשר לראות שנפתח איור? אך לא מופיע בו שום דבר, זאת כיוון שההגדרת ההצגה עצמה תגיע בשכבות הבאות.

### שכבה שניה - הגדרת סוג האיור
כמו שכבר הבנתם, בשיעור נכסה כמה סוגי גרפים. כלומר אפשר להציג את אותם נתונים בכמה דרכים שונות ובשכבה השניה נדרש לפרט איזה סוג של גרף נרצה לייצר. את זה נעשה על ידי קבוצת הפונקציות geom()__. 
קודם כל נכיר את הפונקציה `geom_point()`, פונקציה שתוסיף לנו את הנקודות ותיצור לנו גרף פיזור כמו שראינו עם הפונקציה הבסיסית קודם לכן. יש בעצם לחבר את השכבות באמצעות הסימן `+` כפי שמודגם בקוד למטה.

```{r}
scores = c(80.2,75.5,60,75.5,75.5,75.5,84,80.2,94)
age = c(21,22,23,56,45,18,36,29,33)
need_for_cognition = data.frame(scores=scores, age=age)

ggplot(need_for_cognition, aes(x=age, y=scores))+ geom_point()
```

שימו לב! את האובייקט רב השכבות של ggplot ניתן לאכסן במשתנה. אכסון של אובייקט הגרף במשתנה יאפשר לנו גמישות, כך שנוכל להוסיף למאפיינים של גרף שכבות נוספות ולבצע עריכות שונות על הגרף. למשל נגדיר גרף שנקרא scatter_plot:

```{r}
scores = c(80.2,75.5,60,75.5,75.5,75.5,84,80.2,94)
age = c(21,22,23,56,45,18,36,29,33)
need_for_cognition = data.frame(scores=scores, age=age)

scatter_plot <- ggplot(need_for_cognition, aes(x=age, y=scores))+ geom_point()

# כדי להציג את הגרף נצטרך לקרוא למשתנה
scatter_plot
```

למשל, במקרה של גרף פיזור, אחד השימושים הנפוצים יותר הם הצגות של מגמות לינאריות. אולי עוד לא נחשפתם למושג וזה בסדר גמור. קורלציה על שם פירסון, או מתאם בין שני משתנים הוא מדד לקשר הלינארי בינהם. המשמעות של המונח לינארי בקצרה, היא קשר בין שני המשתנים שניתן לייצג על ידי קו ישר. הפונקציה שמחשבת ומוסיפה את הקו הישר שמתאר את הקשר נקראת `geom_smooth()`, שכן היא מייצגרת קוים חלקים, אך במקרה זה נצטרך לפרט לה איזה קו שמתאר את הנתונים נרצה להוסיף, כלומר לפרט את השיטה בה יותאם הגרף. עבור קו ישר נבחר בlm שהוא קיצור של linear model. להלן דוגמה:

```{r}
scores = c(80.2,75.5,60,75.5,75.5,75.5,84,80.2,94)
age = c(21,22,23,56,45,18,36,29,33)
need_for_cognition = data.frame(scores=scores, age=age)

scatter_plot <- ggplot(need_for_cognition, aes(x=age, y=scores)) + geom_point() + geom_smooth(method="lm")

# כדי להציג את הגרף נצטרך לקרוא למשתנה
scatter_plot
```

שימו לב! את הארגומנט של השיטה יש להכניס כמחרוזת, כך הפונקציה יכולה לפרש אותה. ארגומנט חשוב נוסף שכדאי להכיר הוא se, הכוונה בse היא בעצם אומדן לסטיית התקן מהקו. אם נגדיר FALSE, יופיע קו ללא סטיית תקן.  

`תרגיל`
ייצרו את אותו גרף שראיתם בדוגמה ללא סטיית התקן והציגו אותו.
```{r smooth_ex, exercise=TRUE, exercise.eval = FALSE}
scores = c(80.2,75.5,60,75.5,75.5,75.5,84,80.2,94)
age = c(21,22,23,56,45,18,36,29,33)
need_for_cognition = data.frame(scores=scores, age=age)

```

```{r smooth_ex-solution}
# נתונים:
scores = c(80.2,75.5,60,75.5,75.5,75.5,84,80.2,94)
age = c(21,22,23,56,45,18,36,29,33)
need_for_cognition = data.frame(scores=scores, age=age)

scatter_plot <- ggplot(need_for_cognition, aes(x=age, y=scores)) + geom_point() + geom_smooth(method="lm", se=FALSE)

scatter_plot

```

### הוספת מימד שלישי לגרף
אז כמו שהבנתם בהדרכה זאת נישאר מוגבלים לשני צירים, אבל זה לא יגביל אותנו מלהציג יותר מ2 משתנים. ניתן להוסיף משתנה שלישי שיתבטא בצבע. כדי לבצע זאת נוסיף להגדרת הצירים (על ידי הפונקציה aes) את הארגומנט col, בה נכניס את השם של הטור שנרצה שיבטא הצבע. זה יכול להיות משנתה מסוג פקטור, כמו בדוגמה למטה:
scatter_plot <- ggplot(need_for_cognition, aes(x=scores, y=age, col=gender) 
שימו לב! התוכנה מייצרת לנו אוטומטית מקרא, שמסביר לנו איזה צבע מייצג איזה קטגוריה. המקרא הזה נקרא באנגלית legend.

כעת נראה דוגמה עם משתנה רציף:

** להוסיף משתנה רציף **

לא חייבים להשתמש בצבע, אפשר גם להשתמש בגודל (size) או בצורה של העיגולים (shape) או גם וגם. פוטנציאלית אפשר להציג כך אפילו יותר משלושה משתנים.
`תרגיל`
הציגו את הגרף שראינו קודם כשהגודל מסמן את המשנה V3 והצבע את V4.
## סוגי גרפים:
BAR PLOT
BOX PLOT
VIOLIN PLOT
HISTOGRAM


## התאמות ותצוגה 
### גבולות הגרף
אחת מההתאמות הנפוצות שאולי נרצה לעשות היא התאמה של הגבולות, של מה הערך הכי נמוך ומה הערך הכי גבוהה שיופיע בכל ציר. התוכנה תגדיר את גבולות הגרף אוטומטית. אך למשל אם נרצה להציג משתנה שהינו בעל ערכים חיוביים בלבד והערך המינימלי שתבחר התוכנה להציג יהיה נמוך מ0 נרצה לשנות זאת, שכן אין משמעות לחלק זה בגרף. כדי לשנות את הגבולות נוכל להשתמש בפונקציות:
`ylim()`
`xlim()`
כל אחת מצפה לקבל וקטור שיכיל את הערך המינימלי והמקסימלי לאותו ציר. למשל:
```{r}
scatter_plot <- ggplot(need_for_cognition, aes(x=score, y=age)) + geom_point()  + geom_smooth(method="lm")
scatter_plot +xlim(c(0, 50)) + ylim(c(0, 100))
```

שמתם לב למודליות של ההשמה של הגרף במשתנה? הוספנו לגרף עוד שכבה מבלי לשנות את הנתונים המקוריים שלו. עם זאת, שימו לב, אם תגדירו טווח קטן מידי, כל הנקודות שנמצאות מחוץ לטווה זה לא יוצגו.
### צבע וגודל
המשתנים שאתם מנסים להציג הם למשל הצבע של מילה שהוצגה? והייתם רוצים שהנקודות יופיעו בירוק במקום בכחול? האמת היא שכדי לשנות צבע וצורה צריך לבצע שינוי בפונקציה המקורית שמייצרת את הנקודות:
```{r}
scatter_plot <- ggplot(need_for_cognition, aes(x=age, y=score)) + geom_point(col="green", size=3)  + geom_smooth(method="lm")
```
את הצבע נשנה על ידי הארגומנט col, בggplot יש שתי אפשרויות לפירוט הצבע. האפשרות הראשונה היא לפי שם והאפשרות השניה היא לפי מאפייני הצבע, צירוף של אותיות ומספרים .

אופציה נוספת היא שימוש ב״פלטות״ מוכנות של צבעים שR  הכינה לכם מראש על ידי הוספת הפונקציה  scale_colour_brewer() והגדרה של פלטת הצבעים הרצויה. למשל:
```{r}
scatter_plot <- ggplot(need_for_cognition, aes(x=age, y=score)) + geom_point(col="green", size=3)  + geom_smooth(method="lm")
scatter_plot + scale_colour_brewer(palette = "Set1")
```
בשיטה הזאת לא צריך לבחור כל צבע בנפרד אלא אפשר לבחור פלטה מוכנה.

תוכלו למצוא פרטים נוספים ואת שמות כל הצבעים בקישור:
[colors](http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/)

### כותרות ושמות הצירים
פן חשוב נוסף של הצגה גרפית הוא האינפורמטיביות של הגרף. האמנם אנחנו כרגע ציירנו את הגרף ואנחנו יודעים בדיוק מה יש בו, אבל אם נרצה לשלוח את הגרף למרצה לסטטיסטיקה נצטרך שהוא גם יוכל להבין אותו מבלי לקרוא את הקוד שלנו. כמה פונקציות שימושיות בהקשר הזה:
`ggtitle` - מגדירה את הכותרת הכללית, ניתן להכניס לה ארגומנט נוסף של subtitle, כלומר תת כותרת שתוצג מתחת לכותרת הראשית.
`xlab` - כותרת של ציר הx
`ylab` - כותרת של ציר הy
 עריכה של הכותרות יכולה להיעשות במרוכז על ידי הפונקציה `labs()` (כלומר קיצור של המילה labels) כמו בקוד מטה 
 
```{r} 
scatter_plot <- ggplot(need_for_cognition, aes(x=score, y=age)) + geom_point(col="green", size=3) + geom_smooth(method="lm")

scatter_plot + labs(title="Need for cogintion score by age", subtitle="From class dataset", y="NFC score", x="Age (years)", caption="linear graph")
``` 

אפשר גם להכניס כותרת למקראים השונים למשל על ידי col=“Names” או size=“Length”
להיכנס לשינוי הלגנד והסדר של ופוזישן שלו?
### עיצוב 
התוכנה גם מציעה לנו לשנות את העיצוב הכולל של הגרף, על ידי בחירת פונקציה מקבוצת הפונקציות של theme. למשל:
```{r} 
scatter_plot <- ggplot(need_for_cognition, aes(x=score, y=age)) + geom_point(col="green", size=3)  + geom_smooth(method="lm")
scatter_plot + theme_classic()
```
תוכלו למצוא את מגוון העיצובים כאן:
[themes](https://ggplot2.tidyverse.org/reference/ggtheme.html)
