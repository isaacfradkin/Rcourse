---
title: "Lesson 10: Simulations" 
author: "Copyright 2024 Psychology Department. Hebrew University of Jerusalem. All rights reserved"
output:
  learnr::tutorial:
    progressive: true
    allow_skip: false


description: >
 <div style='direction: rtl;'>
 
 </div>
       
runtime: shiny_prerendered  
editor_options: 
  markdown: 
    wrap: 72
---


```{=html}
<style>
h1, h2, h3, h4, h5, h6 {
  direction: rtl;
}
p {
  direction: rtl;
}
.text-block1 {
  direction: rtl;       /* Set text direction to right-to-left */
  text-align: right;
  background-color: #e7f3fe; /* Light grey background */
  padding: 10px;
  border-radius: 5px;
  border: 1px solid #ddd; /* Light border */
  margin: 10px 0; /* Space around the block */
}
</style>

```

```{r setup, include=FALSE}
library(learnr)
library(gradethis)
library(Rcourse)
library(ggplot2)
library(tidyverse)

knitr::opts_chunk$set(error = TRUE)
gradethis::gradethis_setup()
```

```{r prepare-df1}

```

## מבוא

במהלך הקורס עד כה התעסקנו רק בניתוח של נתונים אמיתיים. ביחידה זו נלמד כישור חדש - איך ליצור נתונים על סמך הדמיה כדי לבדוק רעיונות תיאורטיים. נלמד כיצד ליצור נתונים מתוך סימולציות ולנתח אותם.

הרעיון יהיה זהה בכל אחת מהדוגמאות שנפגוש ביחידה זו: אנחנו נניח הנחות מסוימות על המציאות ואז נבדוק את התוצאות שהיינו מצפים לקבל בהינתן הנחות אלו. תהליך זה יאפשר לנו לערוך סימולציות של התפלגויות דגימה, במטרה להבין את מידת הרעש הצפויה לנו בנתונים המתבססים על דגימה אקראית ולערוך מבחן עוצמה למבחנים סטטיסטיים פשוטים.

במהלך היחידה נכיר את השימוש בפונקציות הבאות:

**

* מידע כללי על פונקציות הקשורות להתפלגות

## התפלגות דגימה

### דגימה מתוך התפלגות בינומית

הסימולציה הפשוטה ביותר שנוכל לבצע כוללת הדמיה של הטלת מטבע. כיוון שלפעולה זו יש רק 2 תוצאות אפשריות היא מקבילה לדימה מהתפלגות בינומית - המתארת דגימה של 0 או 1 עם הסתברות p ו 1-p.

בR אפשר לבצע דגימה כזו באמצעות הפונקציה `rbinom`.

להלן דוגמה:

```{r}
coin_flip = rbinom(n = 1, size = 1, prob = 0.5)

print(coin_flip)
```

תריצו את הקוד כמה פעמים ותראו שהתוצאה תשתנה בכל פעם. כשקיבלנו 1 המטבע נפל על "עץ" וכשקיבנו 0 המטבע נפל על "פלי".

במידה ונרצה לבצע הטלה של יותר ממטבע אחד נוכל לשנות את הערך של `size` בפונקציה `rbinom`. כעת הפונקציה תחזיר לנו את מספר הפעמיים שקיבלנו "עץ" מתוך כל ההטלות שערכנו.

```{r}
num_heads = rbinom(n = 1, size = 100, prob = 0.5)

print(num_heads)
```

במקרה הנ"ל בדקנו כמה פעמים קיבלו "עץ" מתוך 100 הטלות של מטבע, אבלביצענו את הבדיקה הזו פעם אחת בלבד. כיוון שאנחנו יודעים שהתהליך המתואר הוא אקראי, נרצה לחזור עליו מספר רב של פעמים כדי לראות מה היא ההתפלגות של כלל התוצאות שאנחנו יכולים לקבל עבור 100 הטלות מטבע. התפלגות זו תתאר לנו את התפלגות הדגימה של מספר הפעמים שנקבל עץ עבור מתוך 100 הטלות.

במקרה זה, נוכל ליישם את החזרות  המרובות באמצעות שינוי של הערך של `n` בפונקציה `rbinom`. כשנזין מספר גדול מ1 במקום זה נקבל חזרה וקטור של תוצאות, כשכל ערך בוקטור מבטא חזרה נפרדת על ההטלות שביקשנו.

```{r}
num_heads = rbinom(n = 50, size = 100, prob = 0.5)

print(num_heads)
```

קיבלנו וקטור באורך 50, המכילים את התוצאות מ50 חזרות, כשבכל חזרה הטלנו 100 מטבעות.

נחזור על התהליך שוב, אבל הפעם נחזור על הדגימה 10,000 פעם ונציג את התוצאות בצורה גרפית.

```{r}
num_heads = rbinom(n = 10000, size = 100, prob = 0.5)

df = data.frame(num_heads = num_heads)

ggplot(df, aes(x = num_heads))+
  geom_histogram( bins = 40, fill = "lightblue", color = "black")+
  geom_vline(xintercept = 50 , color = "red", linetype = 2)

```

בגרף ניתן לראות את התוצאות שקיבלנו עבור 10000 חזרות של הטלת מטבע. ניתן לראות שהתוצאות מתפלגות סביב הערך 50, כלומר כמות ה"עצים" שקיבלנו בממוצע עבור 100 ההטלות הייתה סביב 50. התבוננו בתרשים שקיבלתם וענו על השאלה הבאה:

*

למעשה, נוכל לענות על השאלה הנ"ל על ידי חישוב: נעבור על הוקטור שקיבלנו ונבדוק כמה אחוז מהחזרות הניבו ערך קטן יותר מ40. המספר שנקבל ישקף לנו בצורה טובה את הסיכוי לדגום באופן אקראי פחות מ40 פעמים "עץ" מתוך 100 הטלות מטבע. 


``` {r}
num_heads = rbinom(n = 10000, size = 100, prob = 0.5)

df = data.frame(num_heads = num_heads)

p_value = sum(num_heads < 40) / 10000

ggplot(df, aes(x = num_heads))+
  geom_histogram( bins = 40, aes(fill = num_heads < 40))+
  labs(fill = "Less than 40")+
  scale_fill_manual(values = c("lightblue","pink"))



```


בנוסף, אנחנו יכולים גם לבצע את התהליך ההפוך - ולבדוק מה הוא הערך שהסיכוי לקבל מספר הטלות "עץ" הקטן ממנו מתאים לערך מסוים.

```{r}
num_heads = rbinom(n = 10000, size = 100, prob = 0.5)

df = data.frame(num_heads = num_heads)

num_heads_5_percent = quantile(num_heads, probs = 0.05)

ggplot(df, aes(x = num_heads))+
  geom_histogram( bins = 40, aes(fill = num_heads < num_heads_5_percent))+
  labs(fill = "Less than 5 percent")+
  scale_fill_manual(values = c("lightblue","pink"))

print(paste0("There is a 5% chance to get less than ",num_heads_5_percent," heads in 100 coin flips"))
```


`תרגיל`

חנה מצאה מטבע ברחוב ורצתה לבדוק אם הוא הוגן (סיכוי לקבל "עץ" הוא 0.5). היא הטילה את המטבע 50 פעם וקיבלה "עץ" ב30 הטלות.
בדקו באמצעות סימולציה מה הסיכוי לקבל את התוצאה שחנה קיבלה במידה והמטבע אכן היה הוגן.

*


### דגימה מתוך התפלגות נורמלית

רוב המדדים שאנחנו מתעניינים בהם בפסיכולוגיה אינם דיכוטומיים, אלא רציפים. רבים מתוכם מתפלגים באופן נורמלי או קרוב לנורמלי באוכלוסייה, ולכן כחוקרים בפסיכולוגיה מאוד שימוש לבצע סימולציות שמערבות דגימה מהתפלגות נורמלית.

הפונקציה שתשמש אותנו במקרים כאלו הינה `rnorm` שמקבלת 3 ערכים: מספר הדגימות, ממוצע וס"ת.


```{r}
one_sample = rnorm(n = 1, mean = 8, sd = 2)

many_samples = rnorm(n = 100, mean = 8, sd = 2)

```

נוכל להשתמש בפונקציה זו כדי לבצע הדמיות שעונות על שאלות דומות לאלו שפגשנו סביב הטלת מטבע. למשל:

אם הינו דוגמים אדם אקראי מתוך קבוצה בה הגובה מתפלג נורמלית עם ממוצע 170 וס"ת 10, מה הסיכוי לקבל אדם בגובה של פחות מ160?

ענו על השאלה הנ"ל באמצעות דגימה של 10,000 אנשים מתוך ההתפלגות המתוארת וחישוב באחוז מתוך הדגימות בהם ערך הגובה קטן או שווה ל160.

*

### התפלגות דגימה 


נניח שאנחנו לא מתעניינים באדם אחד, אלא בממוצע של קבוצת אנשים. במקרים כאלו נוכל להשתמש בפונקציה `rnorm` כדי לדגום את המדגם שלנו ואז לחשב מתוך המדגם את ממוצע המדגם. נוכל לחזור על התהליך שוב ושוב באמצעות לולאה ולחשב את התפלגות הדגימה של הממוצע - התפלגות הממוצעים שאנחנו מצפים לקבל כשאנחנו דוגמים מתוך האוכלוסייה הזו.

נוכל להשתמש בהדמיות כאלו כדי לענות על שאלות כמו:

אם היינו דוגמים מדגם של 20 אנשים מתוך אוכלוסייה ששעות השינה בה מתפלגות נורמלית עם ממוצע 8 וס"ת 2, מה היה הסיכוי לקבל מדגם בו הממוצע הוא פחות מ7?

הקוד יראה כך:

```{r}
iterations = 1000 # מספר החזרות של ההדמיה

means = c()       # וקטור ריק לטובת שמירת הממוצעים
for (i in 1:iterations){
  sample = rnorm(n = 20, mean = 8, sd = 2)
  sample_mean = mean(sample)
  means = c(means, sample_mean)
}

p_value_less_than_7 = sum(means < 7) / iterations

print(paste0("The probability of randomly sampling a sample with a mean less than 7 from this population is: ", p_value_less_than_7*100," %"))

ggplot(data.frame(means), aes(x = means)) +
  geom_histogram(bins = 30, fill = "lightblue", color = "black")+
  geom_vline(xintercept = 7, color = "red", linetype = 2)
             
```


`תרגיל`
*

### דגימה מאוכלוסייה שאינה נורמלית

כל הסימולציות שעשינו עד כה עונות לנו על שאלות שיכולנו לפתור גם באופן אנליטי. לאורך השנים, אנשים פיתחו משוואות שיודעות לחזות את התפלגויות הדגימה עבור הממוצע ומספר סטטיסטיים אחרים ולחשב מתוכן את הסיכוי לקבל מדגמים עם סטטיסטיים קיצוניים יותר מערך נתון. עם זאת, הדמיות מאפשרות לנו לבדוק בקלות גם שאלות שאין להן פתרון אנליטי יודע, או שיש להם פתרון - אבל הוא מורכב ולא נלמד בקורסי הסטטיסטיקה שלקחנו. 

דוגמא אחת שכזו היא מצב בו המדד שאנחנו מתעניינים בו מתפלג באופן מאוד לא נורמלי. למשל - כשהוא מתפלג באוכלוסייה באופן אחיד.  

כדי לדגום מתוך התפלגויות שאינן נורמליות נוכל להיעזר בפונקציות כדוגמת:

1) `runif`
2) `rpois`
3) `rexp`

וכו'


*משפט הגבול המרכזי


### דגימה מתוך וקטור

אם נרצה לדגום מתוך אפשרויות שהגדרנו בעצמנו, נוכל להשתמש בפונקציה `sample` שמקבלת וקטור ומחזירה דגימה מתוך הווקטור

* דוגמה - הטלות קובייה

* תרגיל - 


## מבחני עוצמה

שימוש נוסף, ואחרון עבור יחידה זו,להדמיות הוא עבור חישוב של עוצמת מבחן.
כפי שלמדתם בשיעור סטטיסטיקה, עוצמת מובחן מוגדרת בתור הסיכוי לקבל תוצאה מובהקת בניסוי שאנחנו מריצים, בהנחה והאפקט שאותו אנחנו מחפשים אכן קיים. אנחנו נרצה לחשב אותה לפני שנריץ את הניסוי כדי לראות שגודל המדגם בחרנו להריץ גדול מספיק כדי לספק לנו סיכוי טוב למצוא את האפקט.

אופן החישוב יעשה  לפי השלבים הבאים:

1) הגדרת האוכלוסייה ממנו אנחנו דוגמים, בהנחה והאפקט שאנחנו מחפשים אכן קיים.
2) דגימה של מדגם בגודל שזהה לגודל המדגם שאנחנו מתכננים לאסוף
3) ביצוע המבחן הסטטיסטי המתוכנן על המדגם שקיבלנו
4) שמירת תוצאות המבחן. 

נחזור על שלבים 2-4 מספר רב של פעמים והקבל התפלגות של תוצאות הניסוי הצפויות. נחשב את הסיכוי לקבל תוצאה מובהקת ונקבל את עוצמת המבחן.


### מבחן Z

נדגים את התהליך על ניסוי הנשען על מבחן Z  למדגם יחיד. מבחן זה מתאים למצבים בהם אנחנו רוצים לבחון האם המדגם שאספנו שייך לאוכלוסייה עם ממוצע וס"ת נתונים. 

למשל: האם *

כדי לבצע את המבחן נוכל להשתמש בפונקציה `pnorm` שמחזירה את הסיכוי לקבל תוצאה קטנה או שווה לערך מסוים מתוך התפלגות נורמלית.

ההתפלגות שמולה נרצה לבדוק את הממוצע שקיבלנו במדגם זו התפלגות הדגימה של ממוצעי מדגמים בגודל הזהה לגודל המדגם שלנו.*


דוגמה *

תרגיל *

השוואה לפתרון אנליטי


## הגשה
  עברו על הקובץ וודאו שהגשתם את כל התרגילים ועניתם על כל השאלות
  
  במידה וכל התשובות שלכם תקינות יש ללחוץ על הכפתור:  Generate, להעתיק את הטקסט שמופיע בחלון למטה ולהגישו במודל  
  בהצלחה!

```{r context="server"}
learnrhash::encoder_logic()
```

```{r encode, echo=FALSE}
learnrhash::encoder_ui()
```